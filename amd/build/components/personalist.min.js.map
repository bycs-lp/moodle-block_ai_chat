{"version":3,"file":"personalist.min.js","sources":["../../src/components/personalist.js"],"sourcesContent":["import BaseContent from 'block_ai_chat/components/base_content';\nimport {getString} from 'core/str';\nimport {PERSONA_TYPES} from 'block_ai_chat/constants';\nimport Templates from 'core/templates';\n\n\n/**\n * Component representing the list of available personas.\n */\nclass PersonaList extends BaseContent {\n\n    static init(target) {\n        let element = document.querySelector(target);\n        return new this({\n            element: element,\n        });\n    }\n\n    create() {\n        this.selectors = {\n            PERSONA_LIST_ITEM_SELECTED: `[data-block_ai_chat-element=\"personalistitem\"].block_ai_chat-selected-personaitem`,\n            PERSONALIST_CONTENT: `[data-block_ai_chat-component=\"personalist-content\"]`,\n            ADD_NEW_PERSONA_BUTTON: `[data-block_ai_chat-element=\"addnewpersonabutton\"]`,\n            BACK_TO_CHAT_BUTTON: `[data-block_ai_chat-element='backtochatbutton']`,\n            SELECT_PERSONA_BUTTON: `[data-block_ai_chat-element='selectpersonabutton']`\n        };\n    }\n\n    stateReady() {\n        this._hideContent();\n    }\n\n    /**\n     * Watchers for this component.\n     * @returns {array}\n     */\n    getWatchers() {\n        return [\n            ...super.getWatchers(),\n            {watch: `personas:created`, handler: this._personaCreated},\n            {watch: `personas:updated`, handler: this._renderContent},\n        ];\n    }\n\n    async _renderContent() {\n        const nopersonaString = await getString('nopersona', 'block_ai_chat');\n        const templateContext = {\n            generalpersonas: [\n                {\n                    id: 0,\n                    name: nopersonaString,\n                    nopersona: true\n                }\n            ],\n            templatepersonas: [],\n            userpersonas: []\n        };\n        // Sort alphabetically by name.\n        const personas = Array.from(this.reactive.state.personas.values());\n        personas.sort((a, b) => a.name.localeCompare(b.name));\n        personas.forEach((persona) => {\n            const personaTemplateObject = this._exportPersonaForTemplate(persona);\n            if (parseInt(persona.type) === PERSONA_TYPES.TYPE_TEMPLATE) {\n                templateContext.templatepersonas.push(personaTemplateObject);\n            } else if (parseInt(persona.type) === PERSONA_TYPES.TYPE_USER) {\n                templateContext.userpersonas.push(personaTemplateObject);\n            }\n        });\n\n        const {html, js} = await Templates.renderForPromise('block_ai_chat/personalist_content', templateContext);\n        Templates.replaceNodeContents(this.getElement(), html, js);\n\n        await this._setupAfterContentRendering();\n    }\n\n    _handleSelectPersona() {\n        this.reactive.dispatch('selectCurrentPersonaAndLoadChat', this.reactive.state.config.currentlyMarkedPersona);\n    }\n\n    _handleAddNewPersona() {\n        this.reactive.dispatch('createNewDummyPersona');\n    }\n\n    async _personaCreated({element}) {\n        let placeholder = document.createElement('div');\n        placeholder.setAttribute('data-block_ai_chat-persona-id', element.id);\n        this.getElement(this.selectors.PERSONALIST_CONTENT).appendChild(placeholder);\n        const newcomponent = await this.renderComponent(\n            placeholder,\n            'block_ai_chat/components/personalistitem',\n            this._exportPersonaForTemplate(this.reactive.state.personas.get(element.id))\n        );\n        const newelement = newcomponent.getElement();\n        this.getElement(this.selectors.PERSONALIST_CONTENT).replaceChild(newelement, placeholder);\n    }\n\n    _handleBackToChat() {\n        this.reactive.dispatch('setView', 'chat');\n    }\n\n    _setupAfterContentRendering() {\n        this.addEventListener(this.getElement(this.selectors.ADD_NEW_PERSONA_BUTTON),\n            'click',\n            this._handleAddNewPersona\n        );\n        this.addEventListener(this.getElement(this.selectors.BACK_TO_CHAT_BUTTON),\n            'click',\n            this._handleBackToChat\n        );\n        this.addEventListener(this.getElement(this.selectors.SELECT_PERSONA_BUTTON),\n            'click',\n            this._handleSelectPersona\n        );\n    }\n\n    _exportPersonaForTemplate(persona) {\n        return {\n            id: persona.id,\n            name: persona.name,\n            nopersona: false,\n            editable:\n                this.reactive.state.static.isAdmin\n                ||\n                (\n                    this.reactive.state.static.canEditSystemPersonas\n                    && parseInt(persona.type) === PERSONA_TYPES.TYPE_TEMPLATE\n                )\n                ||\n                (\n                    parseInt(persona.type) === PERSONA_TYPES.TYPE_USER\n                    && parseInt(this.reactive.state.static.userid) === parseInt(persona.userid)\n                ),\n        };\n    }\n\n    getViewName() {\n        return 'personalist';\n    }\n}\n\nexport default PersonaList;\n"],"names":["PersonaList","BaseContent","target","this","element","document","querySelector","create","selectors","PERSONA_LIST_ITEM_SELECTED","PERSONALIST_CONTENT","ADD_NEW_PERSONA_BUTTON","BACK_TO_CHAT_BUTTON","SELECT_PERSONA_BUTTON","stateReady","_hideContent","getWatchers","super","watch","handler","_personaCreated","_renderContent","templateContext","generalpersonas","id","name","nopersona","templatepersonas","userpersonas","personas","Array","from","reactive","state","values","sort","a","b","localeCompare","forEach","persona","personaTemplateObject","_exportPersonaForTemplate","parseInt","type","PERSONA_TYPES","TYPE_TEMPLATE","push","TYPE_USER","html","js","Templates","renderForPromise","replaceNodeContents","getElement","_setupAfterContentRendering","_handleSelectPersona","dispatch","config","currentlyMarkedPersona","_handleAddNewPersona","placeholder","createElement","setAttribute","appendChild","newelement","renderComponent","get","replaceChild","_handleBackToChat","addEventListener","editable","static","isAdmin","canEditSystemPersonas","userid","getViewName"],"mappings":"+dASMA,oBAAoBC,kCAEVC,eAED,IAAIC,KAAK,CACZC,QAFUC,SAASC,cAAcJ,UAMzCK,cACSC,UAAY,CACbC,+GACAC,2EACAC,4EACAC,sEACAC,4EAIRC,kBACSC,eAOTC,oBACW,IACAC,MAAMD,cACT,CAACE,yBAA2BC,QAAShB,KAAKiB,iBAC1C,CAACF,yBAA2BC,QAAShB,KAAKkB,8CAMxCC,gBAAkB,CACpBC,gBAAiB,CACb,CACIC,GAAI,EACJC,WALkB,kBAAU,YAAa,iBAMzCC,WAAW,IAGnBC,iBAAkB,GAClBC,aAAc,IAGZC,SAAWC,MAAMC,KAAK5B,KAAK6B,SAASC,MAAMJ,SAASK,UACzDL,SAASM,MAAK,CAACC,EAAGC,IAAMD,EAAEX,KAAKa,cAAcD,EAAEZ,QAC/CI,SAASU,SAASC,gBACRC,sBAAwBtC,KAAKuC,0BAA0BF,SACzDG,SAASH,QAAQI,QAAUC,yBAAcC,cACzCxB,gBAAgBK,iBAAiBoB,KAAKN,uBAC/BE,SAASH,QAAQI,QAAUC,yBAAcG,WAChD1B,gBAAgBM,aAAamB,KAAKN,gCAIpCQ,KAACA,KAADC,GAAOA,UAAYC,mBAAUC,iBAAiB,oCAAqC9B,oCAC/E+B,oBAAoBlD,KAAKmD,aAAcL,KAAMC,UAEjD/C,KAAKoD,8BAGfC,4BACSxB,SAASyB,SAAS,kCAAmCtD,KAAK6B,SAASC,MAAMyB,OAAOC,wBAGzFC,4BACS5B,SAASyB,SAAS,yDAGLrD,QAACA,cACfyD,YAAcxD,SAASyD,cAAc,OACzCD,YAAYE,aAAa,gCAAiC3D,QAAQoB,SAC7D8B,WAAWnD,KAAKK,UAAUE,qBAAqBsD,YAAYH,mBAM1DI,kBALqB9D,KAAK+D,gBAC5BL,YACA,2CACA1D,KAAKuC,0BAA0BvC,KAAK6B,SAASC,MAAMJ,SAASsC,IAAI/D,QAAQoB,OAE5C8B,kBAC3BA,WAAWnD,KAAKK,UAAUE,qBAAqB0D,aAAaH,WAAYJ,aAGjFQ,yBACSrC,SAASyB,SAAS,UAAW,QAGtCF,mCACSe,iBAAiBnE,KAAKmD,WAAWnD,KAAKK,UAAUG,wBACjD,QACAR,KAAKyD,2BAEJU,iBAAiBnE,KAAKmD,WAAWnD,KAAKK,UAAUI,qBACjD,QACAT,KAAKkE,wBAEJC,iBAAiBnE,KAAKmD,WAAWnD,KAAKK,UAAUK,uBACjD,QACAV,KAAKqD,sBAIbd,0BAA0BF,eACf,CACHhB,GAAIgB,QAAQhB,GACZC,KAAMe,QAAQf,KACdC,WAAW,EACX6C,SACIpE,KAAK6B,SAASC,MAAMuC,OAAOC,SAGvBtE,KAAK6B,SAASC,MAAMuC,OAAOE,uBACxB/B,SAASH,QAAQI,QAAUC,yBAAcC,eAI5CH,SAASH,QAAQI,QAAUC,yBAAcG,WACtCL,SAASxC,KAAK6B,SAASC,MAAMuC,OAAOG,UAAYhC,SAASH,QAAQmC,SAKpFC,oBACW,4BAIA5E"}