{"version":3,"file":"headeractions.min.js","sources":["../../src/components/headeractions.js"],"sourcesContent":["import {BaseComponent} from 'core/reactive';\nimport {getString} from 'core/str';\nimport {confirm as confirmModal, alert as alertModal} from 'core/notification';\nimport ModalForm from 'core_form/modalform';\nimport ModalCancel from 'core/modal_cancel';\nimport {MODES} from 'block_ai_chat/constants';\n\n/**\n * Component representing a message in the ai_chat.\n */\nclass HeaderActions extends BaseComponent {\n\n    /**\n     * Function to initialize component, called by mustache template.\n     *\n     * @param {*} target The id of the HTMLElement to attach to\n     * @returns {BaseComponent} New component attached to the HTMLElement represented by target\n     */\n    static init(target) {\n        let element = document.querySelector(target);\n        return new this({\n            element: element,\n        });\n    }\n\n    create() {\n        this.name = 'headeractions';\n        this.selectors = {\n            NEW_CONVERSATION_BUTTON: '[data-block_ai_chat-element=\"newconversationbutton\"]',\n            SHOW_HISTORY_BUTTON: '[data-block_ai_chat-element=\"showhistorybutton\"]',\n            PERSONA_LIST_BUTTON: '[data-block_ai_chat-element=\"personalistbutton\"]',\n            OPTIONS_BUTTON: '[data-block_ai_chat-element=\"optionsbutton\"]',\n            DELETE_CONVERSATION_BUTTON: '[data-block_ai_chat-element=\"deleteconversationbutton\"]',\n            VIEWMODE_WINDOW_BUTTON: '[data-block_ai_chat-element=\"viewmodewindowbutton\"]',\n            VIEWMODE_OPENFULL_BUTTON: '[data-block_ai_chat-element=\"viewmodeopenfullbutton\"]',\n            VIEWMODE_DOCKRIGHT_BUTTON: '[data-block_ai_chat-element=\"viewmodedockrightbutton\"]',\n            MODE_SWITCH: `[data-block_ai_chat-element='modeswitch']`,\n            PERSONA_BANNER: `[data-block_ai_chat-element='personabanner']`,\n            PERSONA_INFO_MODAL_MANAGE_PERSONA_BUTTON: `[data-block_ai_chat-element='personainfomodalpersonalistbutton']`,\n            MFORM: `form.mform`,\n        };\n    }\n\n    async stateReady(state) {\n        await this._modeUpdated({element: state.config});\n        this._refreshPersona({element: state.config});\n\n        this.addEventListener(\n            this.getElement(this.selectors.NEW_CONVERSATION_BUTTON),\n            'click',\n            this._newConversationListener\n        );\n        this.addEventListener(\n            this.getElement(this.selectors.SHOW_HISTORY_BUTTON),\n            'click',\n            this._showHistoryListener\n        );\n        const personaListButton = this.getElement(this.selectors.PERSONA_LIST_BUTTON);\n        if (personaListButton) {\n            this.addEventListener(\n                this.getElement(this.selectors.PERSONA_LIST_BUTTON),\n                'click',\n                this._showPersonalistListener\n            );\n        }\n        this.addEventListener(\n            this.getElement(this.selectors.PERSONA_BANNER),\n            'click',\n            this._showPersonaInfoModal\n        );\n\n        const modeSwitch = this.getElement(this.selectors.MODE_SWITCH);\n        if (modeSwitch) {\n            this.addEventListener(\n                this.getElement(this.selectors.MODE_SWITCH),\n                'click',\n                this._clickModeSwitchListener\n            );\n        }\n\n        const optionsButton = this.getElement(this.selectors.OPTIONS_BUTTON);\n        if (optionsButton) {\n            this.addEventListener(\n                this.getElement(this.selectors.OPTIONS_BUTTON),\n                'click',\n                this._renderOptionsForm\n            );\n        }\n        this.addEventListener(\n            this.getElement(this.selectors.DELETE_CONVERSATION_BUTTON),\n            'click',\n            this._deleteConversationListener\n        );\n\n        const viewModeWindowButton = this.getElement(this.selectors.VIEWMODE_WINDOW_BUTTON);\n        if (viewModeWindowButton) {\n            this.addEventListener(\n                this.getElement(this.selectors.VIEWMODE_WINDOW_BUTTON),\n                'click',\n                this._setWindowModeListener.bind(this, 'window')\n            );\n        }\n        const viewModeOpenFullButton = this.getElement(this.selectors.VIEWMODE_OPENFULL_BUTTON);\n        if (viewModeOpenFullButton) {\n            this.addEventListener(\n                this.getElement(this.selectors.VIEWMODE_OPENFULL_BUTTON),\n                'click',\n                this._setWindowModeListener.bind(this, 'openfull')\n            );\n        }\n        const viewModeDockRightButton = this.getElement(this.selectors.VIEWMODE_DOCKRIGHT_BUTTON);\n        if (viewModeDockRightButton) {\n            this.addEventListener(\n                this.getElement(this.selectors.VIEWMODE_DOCKRIGHT_BUTTON),\n                'click',\n                this._setWindowModeListener.bind(this, 'dockright')\n            );\n        }\n    }\n\n    /**\n     * Watchers for this component.\n     * @returns {array}\n     */\n    getWatchers() {\n        return [\n            // We update if we switch personas.\n            {watch: `config.mode:updated`, handler: this._modeUpdated},\n            {watch: `config.currentPersona:updated`, handler: this._refreshPersona},\n            // We also have to update if the persona information changes.\n            {watch: `personas:updated`, handler: this._personaInformationChanged},\n        ];\n    }\n\n\n    _selectCurrentPersonaListener(event) {\n        event.preventDefault();\n        this.reactive.dispatch('selectCurrentPersona', this.reactive.state.static.contextid, event.target.value);\n    }\n\n    _newConversationListener(event) {\n        event.preventDefault();\n        this.reactive.dispatch('createAndViewNewConversation');\n    }\n\n    _showHistoryListener(event) {\n        event.preventDefault();\n        this.reactive.dispatch('setView', 'history');\n    }\n\n    _showPersonalistListener(event) {\n        event.preventDefault();\n        this.reactive.dispatch('setView', 'personalist');\n    }\n\n    async _renderOptionsForm() {\n        const optionsFormModalTitle = await getString('preferences', 'block_ai_chat');\n        const optionsForm = new ModalForm({\n            formClass: \"block_ai_chat\\\\form\\\\options_form\",\n            moduleName: \"core/modal_save_cancel\",\n            args: {\n                contextid: this.reactive.state.static.contextid,\n                component: this.reactive.state.static.component\n            },\n            modalConfig: {\n                title: optionsFormModalTitle,\n            },\n        });\n\n        optionsForm.show();\n        this.addEventListener(optionsForm, optionsForm.events.FORM_SUBMITTED, this._optionsSubmitted);\n    }\n\n    async _deleteConversationListener(event) {\n        event.preventDefault();\n        const deletetext = await getString('delete', 'core');\n        const confirmtext = await getString('deletewarning', 'block_ai_chat');\n        const canceltext = await getString('cancel', 'moodle');\n        confirmModal(\n            deletetext,\n            confirmtext,\n            deletetext,\n            canceltext,\n            () => {\n                this.reactive.dispatch('deleteCurrentConversation');\n            }\n        );\n    }\n\n    _setWindowModeListener(windowMode) {\n        this.reactive.dispatch('setWindowMode', windowMode);\n    }\n\n    /**\n     * We will trigger that method any time a person data changes. This method is used by stateReady\n     * but, most important, to watch the state. Any watcher receive an object with:\n     * - element: the afected element (a person in this case)\n     * - state: the full state object\n     *\n     * @param {object} param the watcher param.\n     * @param {object} param.element the person structure.\n     */\n    _refreshPersona({element}) {\n        // We have a convenience method to locate elements inside the component.\n        const newPersonaId = parseInt(element.currentPersona);\n        const personaBanner = this.getElement(this.selectors.PERSONA_BANNER);\n        const currentMode = this.reactive.state.config.mode;\n        if (newPersonaId === 0 || currentMode === MODES.AGENT) {\n            personaBanner.classList.add('d-none');\n        } else {\n            personaBanner.classList.remove('d-none');\n            personaBanner.innerHTML = `${this.reactive.state.personas.get(newPersonaId).userinfo}`;\n        }\n    }\n\n    _personaInformationChanged({element}) {\n        if (parseInt(this.reactive.state.config.currentPersona) !== element.id) {\n            return;\n        }\n        this._refreshPersona({element: this.reactive.state.config});\n    }\n\n    _optionsSubmitted(event) {\n        this.reactive.dispatch('processDynamicFormUpdates', event.detail);\n    }\n\n    async _showPersonaInfoModal() {\n        const currentPersonaId = parseInt(this.reactive.state.config.currentPersona);\n\n        const personalink = this.reactive.state.static.personalink;\n        const personalinkAvailable = personalink !== null;\n        const templateContext = {\n            personaSelected: currentPersonaId !== 0,\n            personalinkAvailable\n        };\n        if (personalinkAvailable) {\n            templateContext.personalink = personalink;\n        }\n        if (currentPersonaId !== 0) {\n            const currentPersona = this.reactive.state.personas.get(currentPersonaId);\n            templateContext.personaName = currentPersona.name;\n            templateContext.personaUserInfo = currentPersona.userinfo;\n            templateContext.personaPrompt = currentPersona.prompt;\n        }\n        templateContext.showPersona = this.reactive.state.static.showPersona;\n\n        const personaInfoModal = await ModalCancel.create(\n            {\n                large: false,\n                template: 'block_ai_chat/persona_info_modal',\n                templateContext\n            }\n        );\n        await personaInfoModal.show();\n        const managePersonasButton =\n            personaInfoModal.getModal()[0].querySelector(this.selectors.PERSONA_INFO_MODAL_MANAGE_PERSONA_BUTTON);\n        if (managePersonasButton) {\n            managePersonasButton.addEventListener('click', (event) => {\n                event.preventDefault();\n                this.reactive.dispatch('setView', 'personalist');\n                personaInfoModal.hide();\n            });\n        }\n    }\n\n    async _modeUpdated({element}) {\n        const modeChatString = await getString('modechat', 'block_ai_chat');\n        const modeAgentString = await getString('modeagent', 'block_ai_chat');\n        const modeSwitch = this.getElement(this.selectors.MODE_SWITCH);\n        if (!modeSwitch) {\n            // We have no mode switch, so nothing to do.\n            return;\n        }\n        const mformElement = document.querySelector(this.selectors.MFORM);\n        if (\n            // TODO this can be improved, for example does not really work for dynamically hidden\n            //  forms like the one mod/forum/view.php.\n            mformElement\n            && window.getComputedStyle(mformElement).display !== 'none'\n            && window.getComputedStyle(mformElement).visibility !== 'hidden'\n        ) {\n            modeSwitch.classList.remove('d-none');\n        } else {\n            modeSwitch.classList.add('d-none');\n            this.reactive.dispatch('setMode', MODES.CHAT);\n        }\n\n        modeSwitch.innerText = element.mode === MODES.AGENT ? modeAgentString : modeChatString;\n        if (element.mode === MODES.AGENT) {\n            modeSwitch.classList.remove('bg-dark');\n            modeSwitch.classList.add('bg-primary');\n        } else {\n            modeSwitch.classList.remove('bg-primary');\n            modeSwitch.classList.add('bg-dark');\n        }\n        // We need to check if we need to show or hide the persona banner.\n        this._refreshPersona({element: this.reactive.state.config});\n    }\n\n    async _clickModeSwitchListener() {\n        if (\n            this.reactive.state.config.mode === MODES.CHAT\n            && this.reactive.state.static.agentModeUnavailablePagetypes.includes(document.body.id)\n        ) {\n            const title = await getString('agentmodeunavailableonpagetitle', 'block_ai_chat');\n            const message = await getString('agentmodeunavailableonpagemessage', 'block_ai_chat');\n            await alertModal(title, message);\n            return;\n        }\n        const currentMode = this.reactive.state.config.mode;\n        const newMode = currentMode === MODES.AGENT ? MODES.CHAT : MODES.AGENT;\n        this.reactive.dispatch('setMode', newMode);\n    }\n}\n\nexport default HeaderActions;\n"],"names":["HeaderActions","BaseComponent","target","this","element","document","querySelector","create","name","selectors","NEW_CONVERSATION_BUTTON","SHOW_HISTORY_BUTTON","PERSONA_LIST_BUTTON","OPTIONS_BUTTON","DELETE_CONVERSATION_BUTTON","VIEWMODE_WINDOW_BUTTON","VIEWMODE_OPENFULL_BUTTON","VIEWMODE_DOCKRIGHT_BUTTON","MODE_SWITCH","PERSONA_BANNER","PERSONA_INFO_MODAL_MANAGE_PERSONA_BUTTON","MFORM","state","_modeUpdated","config","_refreshPersona","addEventListener","getElement","_newConversationListener","_showHistoryListener","_showPersonalistListener","_showPersonaInfoModal","_clickModeSwitchListener","_renderOptionsForm","_deleteConversationListener","_setWindowModeListener","bind","getWatchers","watch","handler","_personaInformationChanged","_selectCurrentPersonaListener","event","preventDefault","reactive","dispatch","static","contextid","value","optionsFormModalTitle","optionsForm","ModalForm","formClass","moduleName","args","component","modalConfig","title","show","events","FORM_SUBMITTED","_optionsSubmitted","deletetext","confirmtext","canceltext","windowMode","newPersonaId","parseInt","currentPersona","personaBanner","currentMode","mode","MODES","AGENT","classList","add","remove","innerHTML","personas","get","userinfo","id","detail","currentPersonaId","personalink","personalinkAvailable","templateContext","personaSelected","personaName","personaUserInfo","personaPrompt","prompt","showPersona","personaInfoModal","ModalCancel","large","template","managePersonasButton","getModal","hide","modeChatString","modeAgentString","modeSwitch","mformElement","window","getComputedStyle","display","visibility","CHAT","innerText","agentModeUnavailablePagetypes","includes","body","message","newMode"],"mappings":"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"}