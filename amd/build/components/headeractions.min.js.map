{"version":3,"file":"headeractions.min.js","sources":["../../src/components/headeractions.js"],"sourcesContent":["import {BaseComponent} from 'core/reactive';\nimport {getString} from 'core/str';\nimport {confirm as confirmModal} from 'core/notification';\nimport ModalForm from 'core_form/modalform';\nimport ModalCancel from 'core/modal_cancel';\n\n/**\n * Component representing a message in the ai_chat.\n */\nclass HeaderActions extends BaseComponent {\n\n    /**\n     * Function to initialize component, called by mustache template.\n     *\n     * @param {*} target The id of the HTMLElement to attach to\n     * @returns {BaseComponent} New component attached to the HTMLElement represented by target\n     */\n    static init(target) {\n        let element = document.querySelector(target);\n        return new this({\n            element: element,\n        });\n    }\n\n    create() {\n        this.name = 'headeractions';\n        this.selectors = {\n            NEW_CONVERSATION_BUTTON: '[data-block_ai_chat-element=\"newconversationbutton\"]',\n            SHOW_HISTORY_BUTTON: '[data-block_ai_chat-element=\"showhistorybutton\"]',\n            PERSONA_LIST_BUTTON: '[data-block_ai_chat-element=\"personalistbutton\"]',\n            OPTIONS_BUTTON: '[data-block_ai_chat-element=\"optionsbutton\"]',\n            DELETE_CONVERSATION_BUTTON: '[data-block_ai_chat-element=\"deleteconversationbutton\"]',\n            VIEWMODE_WINDOW_BUTTON: '[data-block_ai_chat-element=\"viewmodewindowbutton\"]',\n            VIEWMODE_OPENFULL_BUTTON: '[data-block_ai_chat-element=\"viewmodeopenfullbutton\"]',\n            VIEWMODE_DOCKRIGHT_BUTTON: '[data-block_ai_chat-element=\"viewmodedockrightbutton\"]',\n            PERSONABANNER: `[data-block_ai_chat-element='personabanner']`,\n            PERSONA_INFO_MODAL_MANAGE_PERSONA_BUTTON: `[data-block_ai_chat-element='personainfomodalpersonalistbutton']`,\n        };\n    }\n\n    async stateReady(state) {\n        this._refreshPersona({element: state.config});\n\n        this.addEventListener(\n            this.getElement(this.selectors.NEW_CONVERSATION_BUTTON),\n            'click',\n            this._newConversationListener\n        );\n        this.addEventListener(\n            this.getElement(this.selectors.SHOW_HISTORY_BUTTON),\n            'click',\n            this._showHistoryListener\n        );\n        const personaListButton = this.getElement(this.selectors.PERSONA_LIST_BUTTON);\n        if (personaListButton) {\n            this.addEventListener(\n                this.getElement(this.selectors.PERSONA_LIST_BUTTON),\n                'click',\n                this._showPersonalistListener\n            );\n        }\n        this.addEventListener(\n            this.getElement(this.selectors.PERSONABANNER),\n            'click',\n            this._showPersonaInfoModal\n        );\n\n        const optionsButton = this.getElement(this.selectors.OPTIONS_BUTTON);\n        if (optionsButton) {\n            this.addEventListener(\n                this.getElement(this.selectors.OPTIONS_BUTTON),\n                'click',\n                this._renderOptionsForm\n            );\n        }\n        this.addEventListener(\n            this.getElement(this.selectors.DELETE_CONVERSATION_BUTTON),\n            'click',\n            this._deleteConversationListener\n        );\n\n        const viewModeWindowButton = this.getElement(this.selectors.VIEWMODE_WINDOW_BUTTON);\n        if (viewModeWindowButton) {\n            this.addEventListener(\n                this.getElement(this.selectors.VIEWMODE_WINDOW_BUTTON),\n                'click',\n                this._setWindowModeListener.bind(this, 'window')\n            );\n        }\n        const viewModeOpenFullButton = this.getElement(this.selectors.VIEWMODE_OPENFULL_BUTTON);\n        if (viewModeOpenFullButton) {\n            this.addEventListener(\n                this.getElement(this.selectors.VIEWMODE_OPENFULL_BUTTON),\n                'click',\n                this._setWindowModeListener.bind(this, 'openfull')\n            );\n        }\n        const viewModeDockRightButton = this.getElement(this.selectors.VIEWMODE_DOCKRIGHT_BUTTON);\n        if (viewModeDockRightButton) {\n            this.addEventListener(\n                this.getElement(this.selectors.VIEWMODE_DOCKRIGHT_BUTTON),\n                'click',\n                this._setWindowModeListener.bind(this, 'dockright')\n            );\n        }\n    }\n\n    /**\n     * Watchers for this component.\n     * @returns {array}\n     */\n    getWatchers() {\n        return [\n            // We update if we switch personas.\n            {watch: `config.currentPersona:updated`, handler: this._refreshPersona},\n            // We also have to update if the persona information changes.\n            {watch: `personas:updated`, handler: this._personaInformationChanged},\n        ];\n    }\n\n\n    _selectCurrentPersonaListener(event) {\n        event.preventDefault();\n        this.reactive.dispatch('selectCurrentPersona', this.reactive.state.static.contextid, event.target.value);\n    }\n\n    _newConversationListener(event) {\n        event.preventDefault();\n        this.reactive.dispatch('createAndViewNewConversation');\n    }\n\n    _showHistoryListener(event) {\n        event.preventDefault();\n        this.reactive.dispatch('setView', 'history');\n    }\n\n    _showPersonalistListener(event) {\n        event.preventDefault();\n        this.reactive.dispatch('setView', 'personalist');\n    }\n\n    async _renderOptionsForm() {\n        const optionsFormModalTitle = await getString('preferences', 'block_ai_chat');\n        const optionsForm = new ModalForm({\n            formClass: \"block_ai_chat\\\\form\\\\options_form\",\n            moduleName: \"core/modal_save_cancel\",\n            args: {\n                contextid: this.reactive.state.static.contextid,\n            },\n            modalConfig: {\n                title: optionsFormModalTitle,\n            },\n        });\n\n        optionsForm.show();\n        this.addEventListener(optionsForm, optionsForm.events.FORM_SUBMITTED, this._optionsSubmitted);\n    }\n\n    async _deleteConversationListener(event) {\n        event.preventDefault();\n        const deletetext = await getString('delete', 'core');\n        const confirmtext = await getString('deletewarning', 'block_ai_chat');\n        const canceltext = await getString('cancel', 'moodle');\n        confirmModal(\n            deletetext,\n            confirmtext,\n            deletetext,\n            canceltext,\n            () => {\n                this.reactive.dispatch('deleteCurrentConversation');\n            }\n        );\n    }\n\n    _setWindowModeListener(windowMode) {\n        this.reactive.dispatch('setWindowMode', windowMode);\n    }\n\n    /**\n     * We will trigger that method any time a person data changes. This method is used by stateReady\n     * but, most important, to watch the state. Any watcher receive an object with:\n     * - element: the afected element (a person in this case)\n     * - state: the full state object\n     *\n     * @param {object} param the watcher param.\n     * @param {object} param.element the person structure.\n     */\n    _refreshPersona({element}) {\n        // We have a convenience method to locate elements inside the component.\n        const newPersonaId = parseInt(element.currentPersona);\n        const personaBanner = this.getElement(this.selectors.PERSONABANNER);\n        if (newPersonaId === 0) {\n            personaBanner.classList.add('d-none');\n        } else {\n            personaBanner.classList.remove('d-none');\n            personaBanner.innerHTML = `${this.reactive.state.personas.get(newPersonaId).userinfo}`;\n        }\n    }\n\n    _personaInformationChanged({element}) {\n        if (parseInt(this.reactive.state.config.currentPersona) !== element.id) {\n            return;\n        }\n        this._refreshPersona({element: this.reactive.state.config});\n    }\n\n    _optionsSubmitted(event) {\n        this.reactive.dispatch('processDynamicFormUpdates', event.detail);\n    }\n\n    async _showPersonaInfoModal() {\n        const currentPersonaId = parseInt(this.reactive.state.config.currentPersona);\n\n        const personalink = this.reactive.state.static.personalink;\n        const personalinkAvailable = personalink !== null;\n        const templateContext = {\n            personaSelected: currentPersonaId !== 0,\n            personalinkAvailable\n        };\n        if (personalinkAvailable) {\n            templateContext.personalink = personalink;\n        }\n        if (currentPersonaId !== 0) {\n            const currentPersona = this.reactive.state.personas.get(currentPersonaId);\n            templateContext.personaName = currentPersona.name;\n            templateContext.personaUserInfo = currentPersona.userinfo;\n            templateContext.personaPrompt = currentPersona.prompt;\n        }\n        templateContext.showPersona = this.reactive.state.static.showPersona;\n\n        const personaInfoModal = await ModalCancel.create(\n            {\n                large: false,\n                template: 'block_ai_chat/persona_info_modal',\n                templateContext\n            }\n        );\n        await personaInfoModal.show();\n        const managePersonasButton =\n            personaInfoModal.getModal()[0].querySelector(this.selectors.PERSONA_INFO_MODAL_MANAGE_PERSONA_BUTTON);\n        if (managePersonasButton) {\n            managePersonasButton.addEventListener('click', (event) => {\n                event.preventDefault();\n                this.reactive.dispatch('setView', 'personalist');\n                personaInfoModal.hide();\n            });\n        }\n    }\n}\n\nexport default HeaderActions;\n"],"names":["HeaderActions","BaseComponent","target","this","element","document","querySelector","create","name","selectors","NEW_CONVERSATION_BUTTON","SHOW_HISTORY_BUTTON","PERSONA_LIST_BUTTON","OPTIONS_BUTTON","DELETE_CONVERSATION_BUTTON","VIEWMODE_WINDOW_BUTTON","VIEWMODE_OPENFULL_BUTTON","VIEWMODE_DOCKRIGHT_BUTTON","PERSONABANNER","PERSONA_INFO_MODAL_MANAGE_PERSONA_BUTTON","state","_refreshPersona","config","addEventListener","getElement","_newConversationListener","_showHistoryListener","_showPersonalistListener","_showPersonaInfoModal","_renderOptionsForm","_deleteConversationListener","_setWindowModeListener","bind","getWatchers","watch","handler","_personaInformationChanged","_selectCurrentPersonaListener","event","preventDefault","reactive","dispatch","static","contextid","value","optionsFormModalTitle","optionsForm","ModalForm","formClass","moduleName","args","modalConfig","title","show","events","FORM_SUBMITTED","_optionsSubmitted","deletetext","confirmtext","canceltext","windowMode","newPersonaId","parseInt","currentPersona","personaBanner","classList","add","remove","innerHTML","personas","get","userinfo","id","detail","currentPersonaId","personalink","personalinkAvailable","templateContext","personaSelected","personaName","personaUserInfo","personaPrompt","prompt","showPersona","personaInfoModal","ModalCancel","large","template","managePersonasButton","getModal","hide"],"mappings":"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"}