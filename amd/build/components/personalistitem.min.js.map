{"version":3,"file":"personalistitem.min.js","sources":["../../src/components/personalistitem.js"],"sourcesContent":["import {BaseComponent} from 'core/reactive';\nimport ModalForm from 'core_form/modalform';\nimport {confirm as confirmModal} from 'core/notification';\nimport {getString} from 'core/str';\nimport {PERSONA_TYPES} from 'block_ai_chat/constants';\nimport Templates from 'core/templates';\n\n\n/**\n * Component representing the list of available personas.\n */\nclass PersonaListItem extends BaseComponent {\n    /**\n     * Function to initialize component, called by mustache template.\n     *\n     * @param {*} target The id of the HTMLElement to attach to\n     * @returns {BaseComponent} New component attached to the HTMLElement represented by target\n     */\n    static init(target) {\n        let element = document.querySelector(target);\n        return new this({\n            element: element,\n        });\n    }\n\n    create() {\n        this.id = parseInt(this.getElement().dataset.block_ai_chatPersonaId);\n        this.selectors = {\n            PERSONA_NAME_ELEMENT: `[data-block_ai_chat-element='personaname']`,\n            PERSONA_LIST_ITEM: `[data-block_ai_chat-component=\"personalistitem\"]`,\n            EDIT_PERSONA_LINK: `[data-block_ai_chat-element='editpersonalink']`,\n            DUPLICATE_PERSONA_LINK: `[data-block_ai_chat-element='duplicatepersonalink']`,\n            DELETE_PERSONA_LINK: `[data-block_ai_chat-element='deletepersonalink']`,\n        };\n        this.addEventListener(this.getElement(this.selectors.PERSONA_NAME_ELEMENT), 'click', this._handleMarkPersona);\n        if (this.id === 0) {\n            // This is our dummy object \"no persona\", skip it.\n            return;\n        }\n        this.getElement().classList.add('ml-2');\n        const editPersonaLink = this.getElement(this.selectors.EDIT_PERSONA_LINK);\n        if (editPersonaLink) {\n            this.addEventListener(editPersonaLink, 'click', async(e) => {\n                e.preventDefault();\n                await this._renderPersonaEditForm();\n            });\n        }\n\n        this.addEventListener(this.getElement(this.selectors.DUPLICATE_PERSONA_LINK), 'click', (e) => {\n            e.preventDefault();\n            this._handleDuplicatePersona();\n        });\n\n        const deletePersonaLink = this.getElement(this.selectors.DELETE_PERSONA_LINK);\n        if (deletePersonaLink) {\n            this.addEventListener(deletePersonaLink, 'click', async(e) => {\n                e.preventDefault();\n                const deletetext = await getString('delete', 'core');\n                const confirmtext = await this.getDeleteWarningText();\n                const canceltext = await getString('cancel', 'moodle');\n                confirmModal(\n                    deletetext,\n                    confirmtext,\n                    deletetext,\n                    canceltext,\n                    () => {\n                        this.reactive.dispatch('deletePersona', this.id);\n                    }\n                );\n            });\n        }\n    }\n\n    stateReady(state) {\n        this._applyFormatting({element: state.config});\n    }\n\n    getWatchers() {\n        return [\n            {watch: `config.currentlyMarkedPersona:updated`, handler: this._applyFormatting},\n            {watch: `personas[${this.id}]:deleted`, handler: this.remove},\n            // We rerender the whole personalist on updates, because we need to reorder etc.\n            // That's why we do not listen for additional persona updates here.\n        ];\n    }\n\n    /**\n     * Marks this persona list item.\n     */\n    _handleMarkPersona() {\n        this.reactive.dispatch('markPersona', this.id);\n    }\n\n    /**\n     * Applies formatting to the persona list item based on whether it is selected and/or marked.\n     *\n     * @param {{config: object}} the changed sub object of the state (state.config in this case)\n     */\n    _applyFormatting({element}) {\n        if (parseInt(element.currentlyMarkedPersona) === this.id) {\n            this.getElement().classList.add('block_ai_chat-selected-personaitem');\n        } else {\n            this.getElement().classList.remove('block_ai_chat-selected-personaitem');\n        }\n        if (this.id === this.reactive.state.config.currentPersona) {\n            this.getElement().classList.add('block_ai_chat-current-personaitem');\n        } else {\n            this.getElement().classList.remove('block_ai_chat-current-personaitem');\n        }\n    }\n\n    _removePersonaItem() {\n        this.remove();\n    }\n\n    async _renderPersonaEditForm() {\n        const selectedPersona = this.reactive.state.personas.get(this.id);\n        const title = await getString('editpersonatitle', 'block_ai_chat');\n        const personaForm = new ModalForm({\n            formClass: 'block_ai_chat\\\\form\\\\persona_form',\n            moduleName: 'core/modal_save_cancel',\n            args: {\n                contextid: this.reactive.state.static.contextid,\n                personaid: this.id,\n                name: selectedPersona.name,\n                prompt: selectedPersona.prompt,\n                userinfo: selectedPersona.userinfo,\n                userid: selectedPersona.userid,\n                type: selectedPersona.type\n            },\n            modalConfig: {\n                title\n            },\n            returnFocus: this.getElement()\n        });\n        this.addEventListener(personaForm, personaForm.events.FORM_SUBMITTED, this._personaFormSubmitted);\n\n        // Show modal.\n        personaForm.show();\n    }\n\n    _personaFormSubmitted(event) {\n        this.reactive.dispatch('processDynamicFormUpdates', event.detail.content);\n    }\n\n    _handleDuplicatePersona() {\n        this.reactive.dispatch('duplicatePersona', this.id);\n    }\n\n    /**\n     * Generates the warning text that should be shown when deleting this persona.\n     *\n     * The warning text is being customized for template personas which can be used across the whole site.\n     */\n    async getDeleteWarningText() {\n        const isTemplate = this.reactive.state.personas.get(this.id).type === PERSONA_TYPES.TYPE_TEMPLATE;\n        const {html, js} = await Templates.renderForPromise('block_ai_chat/templatedelete_warning', {isTemplate});\n        // Not really needed so far, but in case we need to run any JS in the future.\n        Templates.runTemplateJS(js);\n        return html;\n    }\n}\n\nexport default PersonaListItem;"],"names":["PersonaListItem","BaseComponent","target","this","element","document","querySelector","create","id","parseInt","getElement","dataset","block_ai_chatPersonaId","selectors","PERSONA_NAME_ELEMENT","PERSONA_LIST_ITEM","EDIT_PERSONA_LINK","DUPLICATE_PERSONA_LINK","DELETE_PERSONA_LINK","addEventListener","_handleMarkPersona","classList","add","editPersonaLink","async","e","preventDefault","_renderPersonaEditForm","_handleDuplicatePersona","deletePersonaLink","deletetext","confirmtext","getDeleteWarningText","canceltext","reactive","dispatch","stateReady","state","_applyFormatting","config","getWatchers","watch","handler","remove","currentlyMarkedPersona","currentPersona","_removePersonaItem","selectedPersona","personas","get","title","personaForm","ModalForm","formClass","moduleName","args","contextid","static","personaid","name","prompt","userinfo","userid","type","modalConfig","returnFocus","events","FORM_SUBMITTED","_personaFormSubmitted","show","event","detail","content","isTemplate","PERSONA_TYPES","TYPE_TEMPLATE","html","js","Templates","renderForPromise","runTemplateJS"],"mappings":"ogBAWMA,wBAAwBC,oCAOdC,eAED,IAAIC,KAAK,CACZC,QAFUC,SAASC,cAAcJ,UAMzCK,iBACSC,GAAKC,SAASN,KAAKO,aAAaC,QAAQC,6BACxCC,UAAY,CACbC,kEACAC,qEACAC,mEACAC,6EACAC,6EAECC,iBAAiBhB,KAAKO,WAAWP,KAAKU,UAAUC,sBAAuB,QAASX,KAAKiB,oBAC1E,IAAZjB,KAAKK,eAIJE,aAAaW,UAAUC,IAAI,cAC1BC,gBAAkBpB,KAAKO,WAAWP,KAAKU,UAAUG,mBACnDO,sBACKJ,iBAAiBI,gBAAiB,SAASC,MAAAA,IAC5CC,EAAEC,uBACIvB,KAAKwB,iCAIdR,iBAAiBhB,KAAKO,WAAWP,KAAKU,UAAUI,wBAAyB,SAAUQ,IACpFA,EAAEC,sBACGE,mCAGHC,kBAAoB1B,KAAKO,WAAWP,KAAKU,UAAUK,qBACrDW,wBACKV,iBAAiBU,kBAAmB,SAASL,MAAAA,IAC9CC,EAAEC,uBACII,iBAAmB,kBAAU,SAAU,QACvCC,kBAAoB5B,KAAK6B,uBACzBC,iBAAmB,kBAAU,SAAU,oCAEzCH,WACAC,YACAD,WACAG,YACA,UACSC,SAASC,SAAS,gBAAiBhC,KAAKK,UAOjE4B,WAAWC,YACFC,iBAAiB,CAAClC,QAASiC,MAAME,SAG1CC,oBACW,CACH,CAACC,8CAAgDC,QAASvC,KAAKmC,kBAC/D,CAACG,yBAAmBtC,KAAKK,gBAAekC,QAASvC,KAAKwC,SAS9DvB,0BACSc,SAASC,SAAS,cAAehC,KAAKK,IAQ/C8B,2BAAiBlC,QAACA,cACVK,SAASL,QAAQwC,0BAA4BzC,KAAKK,QAC7CE,aAAaW,UAAUC,IAAI,2CAE3BZ,aAAaW,UAAUsB,OAAO,sCAEnCxC,KAAKK,KAAOL,KAAK+B,SAASG,MAAME,OAAOM,oBAClCnC,aAAaW,UAAUC,IAAI,0CAE3BZ,aAAaW,UAAUsB,OAAO,qCAI3CG,0BACSH,8CAICI,gBAAkB5C,KAAK+B,SAASG,MAAMW,SAASC,IAAI9C,KAAKK,IACxD0C,YAAc,kBAAU,mBAAoB,iBAC5CC,YAAc,IAAIC,mBAAU,CAC9BC,UAAW,oCACXC,WAAY,yBACZC,KAAM,CACFC,UAAWrD,KAAK+B,SAASG,MAAMoB,OAAOD,UACtCE,UAAWvD,KAAKK,GAChBmD,KAAMZ,gBAAgBY,KACtBC,OAAQb,gBAAgBa,OACxBC,SAAUd,gBAAgBc,SAC1BC,OAAQf,gBAAgBe,OACxBC,KAAMhB,gBAAgBgB,MAE1BC,YAAa,CACTd,MAAAA,OAEJe,YAAa9D,KAAKO,oBAEjBS,iBAAiBgC,YAAaA,YAAYe,OAAOC,eAAgBhE,KAAKiE,uBAG3EjB,YAAYkB,OAGhBD,sBAAsBE,YACbpC,SAASC,SAAS,4BAA6BmC,MAAMC,OAAOC,SAGrE5C,+BACSM,SAASC,SAAS,mBAAoBhC,KAAKK,uCAS1CiE,WAAatE,KAAK+B,SAASG,MAAMW,SAASC,IAAI9C,KAAKK,IAAIuD,OAASW,yBAAcC,eAC9EC,KAACA,KAADC,GAAOA,UAAYC,mBAAUC,iBAAiB,uCAAwC,CAACN,WAAAA,uCAEnFO,cAAcH,IACjBD,mBAIA5E"}