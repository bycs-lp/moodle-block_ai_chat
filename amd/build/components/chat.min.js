define("block_ai_chat/components/chat",["exports","block_ai_chat/components/base_content","tiny_ai/utils","tiny_ai/editor_utils","tiny_ai/constants","core/templates","local_ai_manager/config","core/str","core/notification","block_ai_chat/utils","theme_boost/bootstrap/popover"],(function(_exports,_base_content,TinyAiUtils,_editor_utils,_constants,_templates,_config,_str,_notification,_utils2,_popover){function _getRequireWildcardCache(nodeInterop){if("function"!=typeof WeakMap)return null;var cacheBabelInterop=new WeakMap,cacheNodeInterop=new WeakMap;return(_getRequireWildcardCache=function(nodeInterop){return nodeInterop?cacheNodeInterop:cacheBabelInterop})(nodeInterop)}function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.default=void 0,_base_content=_interopRequireDefault(_base_content),TinyAiUtils=function(obj,nodeInterop){if(!nodeInterop&&obj&&obj.__esModule)return obj;if(null===obj||"object"!=typeof obj&&"function"!=typeof obj)return{default:obj};var cache=_getRequireWildcardCache(nodeInterop);if(cache&&cache.has(obj))return cache.get(obj);var newObj={},hasPropertyDescriptor=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var key in obj)if("default"!==key&&Object.prototype.hasOwnProperty.call(obj,key)){var desc=hasPropertyDescriptor?Object.getOwnPropertyDescriptor(obj,key):null;desc&&(desc.get||desc.set)?Object.defineProperty(newObj,key,desc):newObj[key]=obj[key]}newObj.default=obj,cache&&cache.set(obj,newObj);return newObj}(TinyAiUtils),_editor_utils=_interopRequireDefault(_editor_utils),_templates=_interopRequireDefault(_templates),_popover=_interopRequireDefault(_popover);class Chat extends _base_content.default{static init(target){return new this({element:document.querySelector(target)})}create(){this.name="ChatComponent",this.selectors={MESSAGES:"[data-block_ai_chat-element='messages']",INPUT_TEXTAREA:"[data-block_ai_chat-element='inputtextarea']",SUBMIT_BUTTON:"[data-block_ai_chat-element='submitbutton']",LOADING_SPINNER_MESSAGE:"[data-block_ai_chat-element='loadingspinner']",TEMPORARY_PROMPT_MESSAGE:"[data-block_ai_chat-element='temporaryprompt']",TINY_AI_BUTTON:"[data-block_ai_chat-element='tinyaibutton']",OUTPUT_WRAPPER:"[data-block_ai_chat-element='outputwrapper']",CHAT_OUTPUT:"[data-block_ai_chat-element='chatoutput']",HISTORY_MARKER:"[data-block_ai_chat-element='historymarker']"}}async stateReady(){this.reactive.dispatch("setView","chat")}getWatchers(){return[...super.getWatchers(),{watch:"messages:created",handler:this._addMessageToChatArea},{watch:"messages:created",handler:this._updateHistoryMarker},{watch:"messages:deleted",handler:this._updateHistoryMarker},{watch:"config.conversationContextLimit:updated",handler:this._updateHistoryMarker},{watch:"personas".concat(this.reactive.state.config.currentPersona,":deleted"),handler:this._removeCurrentPersona},{watch:"config.loadingState:updated",handler:this._handleLoadingStateUpdated}]}async _addMessageToChatArea(_ref){let{element:element}=_ref,placeholder=document.createElement("div");placeholder.setAttribute("data-id",element.id);let node=this.getElement(this.selectors.CHAT_OUTPUT);node.appendChild(placeholder);const templateData={id:element.id,senderai:"ai"===element.sender,content:element.content,loading:!!element.hasOwnProperty("loading")&&element.loading},newelement=(await this.renderComponent(placeholder,"block_ai_chat/components/message",templateData)).getElement();node.replaceChild(newelement,placeholder),this._scrollToBottom(),this._focusInputTextarea()}async _submitAiRequestListener(){const prompt=this.getElement(this.selectors.INPUT_TEXTAREA).value;if(""!==prompt.trim())this.reactive.dispatch("submitAiRequest",prompt);else{const errorString=(0,_str.getString)("erroremptyprompt","block_ai_chat");await(0,_utils2.showErrorToast)(errorString)}}async _handleLoadingStateUpdated(_ref2){let{element:element}=_ref2;const loadingSpinnerMessage={id:"loadingspinner",sender:"ai",loading:!0},temporaryPromptMessage={id:"temporaryprompt",sender:"user",content:this.getElement(this.selectors.INPUT_TEXTAREA).value};element.loadingState&&(await this._addMessageToChatArea({element:temporaryPromptMessage}),await this._addMessageToChatArea({element:loadingSpinnerMessage}),this.getElement(this.selectors.INPUT_TEXTAREA).value="")}_handleKeyDownOnInputTextarea(event){"Enter"!==event.key||event.shiftKey||(event.preventDefault(),this._submitAiRequestListener())}_removeCurrentPersona(){this.reactive.dispatch("selectCurrentPersona",0)}async _updateHistoryMarker(){setTimeout((async()=>{const existingMarker=this.getElement().querySelector(this.selectors.HISTORY_MARKER);existingMarker&&existingMarker.remove();const chatOutput=this.getElement(this.selectors.CHAT_OUTPUT);if(!chatOutput)return;const messages=Array.from(chatOutput.querySelectorAll('[data-block_ai_chat-component="message"]')),contextLimit=this.reactive.state.config.conversationContextLimit;if(messages.length<=contextLimit)return;const messageBeforeContext=messages[messages.length-2*contextLimit-1];if(messageBeforeContext){const marker=document.createElement("div");marker.setAttribute("data-block_ai_chat-element","historymarker"),marker.className="block_ai_chat-history-marker";const historyLengthInfo=await(0,_str.getString)("historylengthinfo","block_ai_chat");marker.innerHTML='\n                    <hr class="block_ai_chat-history-line">\n                    <span class="badge rounded-pill text-primary bg-secondary cursor-pointer" role="button" tabindex="0"\n                        data-bs-container="body" data-bs-toggle="popover" data-bs-placement="top"\n                        data-bs-content="'.concat(historyLengthInfo,'" data-bs-trigger="focus"\n                        aria-label="').concat(historyLengthInfo,'">').concat(contextLimit,"</span>\n                "),messageBeforeContext.after(marker);const badgeElement=marker.querySelector(".badge");badgeElement&&new _popover.default(badgeElement)}}),100)}async _renderContent(){const{html:html,js:js}=await _templates.default.renderForPromise("block_ai_chat/chat_content",{});_templates.default.replaceNodeContents(this.getElement(),html,js),await this._setupAfterContentRendering();const availabilityErrorMessage=await this.isAiChatAvailable();if(""!==availabilityErrorMessage){const notice=await(0,_str.getString)("notice","block_ai_chat");await(0,_notification.alert)(notice,availabilityErrorMessage),this.setElementLocked(this.getElement(this.selectors.INPUT_TEXTAREA),!0),this.setElementLocked(this.getElement(this.selectors.SUBMIT_BUTTON),!0),this.getElement(this.selectors.INPUT_TEXTAREA).disabled=!0,this.getElement(this.selectors.SUBMIT_BUTTON).disabled=!0}}async _setupAfterContentRendering(){this.reactive.dispatch("loadCurrentConversationMessages");const inputTextarea=this.getElement(this.selectors.INPUT_TEXTAREA),sendRequestButton=this.getElement(this.selectors.SUBMIT_BUTTON),tinyAiButton=this.getElement(this.selectors.TINY_AI_BUTTON),uniqid=Math.random().toString(16).slice(2);await TinyAiUtils.init(uniqid,this.reactive.state.static.contextid,_constants.constants.modalModes.standalone),this.addEventListener(tinyAiButton,"click",(async()=>{const selectionObject=window.getSelection();if(selectionObject.rangeCount>0){const range=selectionObject.getRangeAt(0),container=document.createElement("div");container.appendChild(range.cloneContents());const images=container.querySelectorAll("img");if(images.length>0&&images[0].src){const image=images[0],fetchResult=await fetch(image.src),data=await fetchResult.blob();TinyAiUtils.getDatamanager(uniqid).setSelectionImg(data)}selectionObject.toString()&&selectionObject.toString().length>0&&TinyAiUtils.getDatamanager(uniqid).setSelection(selectionObject.toString())}const editorUtils=new _editor_utils.default(uniqid,"block_ai_chat",this.reactive.state.static.contextid,this.reactive.state.static.userid,null);TinyAiUtils.setEditorUtils(uniqid,editorUtils),await editorUtils.displayDialogue()})),this.addEventListener(sendRequestButton,"click",this._submitAiRequestListener),this.addEventListener(inputTextarea,"keydown",this._handleKeyDownOnInputTextarea),this._scrollToBottom(),this._updateHistoryMarker(),this._enableTextAreaAutoResize(),this._focusInputTextarea()}getViewName(){return"chat"}_scrollToBottom(){const chatOutputWrapper=this.getElement(this.selectors.OUTPUT_WRAPPER);chatOutputWrapper.scrollTop=chatOutputWrapper.scrollHeight}_focusInputTextarea(){const inputTextarea=this.getElement(this.selectors.INPUT_TEXTAREA);requestAnimationFrame((()=>{inputTextarea.focus()}))}_enableTextAreaAutoResize(){const inputTextarea=this.getElement(this.selectors.INPUT_TEXTAREA);this.addEventListener(inputTextarea,"keydown",(()=>{inputTextarea.style.height="auto";const computedStyles=window.getComputedStyle(inputTextarea),lineHeight=parseFloat(computedStyles.lineHeight),paddingTop=parseFloat(computedStyles.paddingTop),paddingBottom=parseFloat(computedStyles.paddingBottom),borderTop=parseFloat(computedStyles.borderTopWidth),borderBottom=parseFloat(computedStyles.borderBottomWidth),maxHeight=4*lineHeight+paddingTop+paddingBottom+borderTop+borderBottom,newHeight=Math.min(inputTextarea.scrollHeight+borderTop+borderBottom,maxHeight);inputTextarea.style.height=newHeight+"px"}))}async isAiChatAvailable(){const contextid=this.reactive.state.static.contextid,aiConfig=await(0,_config.getAiConfig)(contextid,null,["chat"]);return"disabled"===aiConfig.availability.available?aiConfig.availability.errormessage:"disabled"===aiConfig.purposes[0].available?aiConfig.purposes[0].errormessage:""}}var _default=Chat;return _exports.default=_default,_exports.default}));

//# sourceMappingURL=chat.min.js.map