{"version":3,"file":"main.min.js","sources":["../../src/components/main.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\nimport {BaseComponent} from 'core/reactive';\nimport Templates from 'core/templates';\nimport {hash} from 'block_ai_chat/utils';\nimport LocalStorage from 'core/localstorage';\nimport ModalEvents from 'core/modal_events';\nimport {RENDER_MODE} from 'block_ai_chat/constants';\nimport * as FocusLock from 'core/local/aria/focuslock';\n\nclass Main extends BaseComponent {\n\n    create(descriptor) {\n        this.modal = descriptor.modal;\n        this.name = 'MainComponent';\n\n        this.classes = {\n            WINDOWMODE_WINDOW: 'block_ai_chat_chatwindow',\n            WINDOWMODE_OPENFULL: 'block_ai_chat_openfull',\n            WINDOWMODE_DOCKRIGHT: 'block_ai_chat_dockright'\n        };\n        this.selectors = {\n            CONTENTAREA: `[data-block_ai_chat-component='contentarea']`,\n            TITLEAREA_PLACEHOLDER: `[data-block_ai_chat-element='titleareaplaceholder']`\n        };\n    }\n\n    /**\n     * Called, as soon as the state is ready and the component has been fully registered.\n     *\n     * It will render all sub components.\n     *\n     * @param {object} state the initial state\n     */\n    async stateReady(state) {\n        await this._renderSubComponents();\n\n        if (state.static.renderMode === RENDER_MODE.MODAL) {\n            this.getElement().closest('.modal').classList.add('block_ai_chat_modal');\n            // Attach listener to the AI button to call modal.\n            // We cannot use the reactive addEventListener here because the button is outside this component.\n            const button = document.getElementById('ai_chat_button');\n            button.addEventListener('mousedown', async() => {\n                this.reactive.dispatch('setModalVisibility');\n            });\n            // Listening to the 'hidden' event here to fire the mutation is actually pretty bad design.\n            // It should be the other way round that altering the state triggers the modal hide/show.\n            // However, because the modal has also other methods to be closed (ESC key, own close button\n            // outside the control of our reactive component) we have to make sure that these external\n            // close events at least are reflected in our state.\n            this.modal.getRoot().on(ModalEvents.hidden, () => {\n                if (state.config.modalVisible) {\n                    this.reactive.dispatch('setModalVisibility', false);\n                }\n            });\n            // Prevent modal to be closed when clicking outside.\n            this.modal.getRoot().on(ModalEvents.outsideClick, event => {\n                event.preventDefault();\n            });\n            let storedWindowMode = await this._getLastWindowModeFromLocalStorage();\n            if (storedWindowMode === 'window' && window.innerWidth <= 576) {\n                storedWindowMode = 'openfull';\n            }\n            this.reactive.dispatch('setWindowMode', storedWindowMode);\n            this.bodyObserver = this._setupOverflowWatcher();\n            // Initially show modal.\n            this.reactive.dispatch('setModalVisibility', true);\n        }\n\n        // Add a toast region to show toast messages when clicking the copy button\n        // of the messages.\n        // Unfortunately, we cannot use \"addToastRegion\" from 'core/toast', because this would\n        // inject a toast region at the top of the page, not the top of our modal, so we have to\n        // render our own toast wrapper.\n        const {html, js} = await Templates.renderForPromise('block_ai_chat/toast_wrapper', {});\n        Templates.prependNodeContents(this.getElement(this.selectors.CONTENTAREA), html, js);\n    }\n\n    destroy() {\n        if (this.bodyObserver) {\n            this.bodyObserver.disconnect();\n        }\n    }\n\n    getWatchers() {\n        return [\n            {watch: `config.windowMode:updated`, handler: this._handleWindowModeUpdated},\n            {watch: `config.windowMode:updated`, handler: this._storeWindowModeToLocalStorage},\n            {watch: `config.modalVisible:updated`, handler: this._toggleModalVisibility},\n        ];\n    }\n\n    async _handleWindowModeUpdated({element}) {\n        const body = document.querySelector('body');\n        Array.from(Object.values(this.classes)).forEach((classname) => {\n            body.classList.remove(classname);\n        });\n        let windowModeClass = null;\n        switch (element.windowMode) {\n            case 'window':\n                windowModeClass = this.classes.WINDOWMODE_WINDOW;\n                break;\n            case 'openfull':\n                windowModeClass = this.classes.WINDOWMODE_OPENFULL;\n                break;\n            case 'dockright':\n                windowModeClass = this.classes.WINDOWMODE_DOCKRIGHT;\n                break;\n        }\n        body.classList.add(windowModeClass);\n    }\n\n    async _getLastWindowModeFromLocalStorage() {\n        const key = await hash('chatmode' + this.reactive.state.static.userid);\n        // Check for saved WINDOWMODE.\n        const currentValue = LocalStorage.get(key);\n        return currentValue ? currentValue : 'window';\n    }\n\n    async _storeWindowModeToLocalStorage() {\n        const key = await hash('chatmode' + this.reactive.state.static.userid);\n        LocalStorage.set(key, this.reactive.state.config.windowMode);\n    }\n\n    async _toggleModalVisibility({element}) {\n        if (this.reactive.state.static.renderMode === RENDER_MODE.EMBEDDED) {\n            return;\n        }\n        if (element.modalVisible) {\n            await this.modal.show();\n            // Disable focus trapping so that you can edit form elements while having the chatbot open.\n            FocusLock.untrapFocus();\n            document.body.classList.add('block_ai_chat_open');\n        } else {\n            await this.modal.hide();\n            document.body.classList.remove('block_ai_chat_open');\n        }\n    }\n\n    /**\n     * Keeps the body overflow in check while the chat modal is open.\n     *\n     * This is pretty ugly, but: Whenever a bootstrap modal is being rendered the overflow style of the body\n     * will be set to \"hidden\" to prevent scrolling of the background. However, in our case we want to\n     * allow scrolling of the background while the chat modal is open. Therefore, we need to watch for\n     * changes of the body style attribute and remove the overflow hidden if our chat modal is open. We cannot do this\n     * in reaction to the modal open/close events, because this happens for each(!) modal, so also notification modals,\n     * confirm modals, dynamic forms etc.\n     *\n     * @returns {MutationObserver} the mutation observer object\n     */\n    _setupOverflowWatcher() {\n        const observer = new MutationObserver((mutations) => {\n            mutations.forEach((mutation) => {\n                if (mutation.type === 'attributes' && mutation.attributeName === 'style') {\n                    const body = document.body;\n                    const computedStyle = window.getComputedStyle(body);\n\n                    if (computedStyle.overflow === 'hidden' && this.reactive.state.config.modalVisible) {\n                        document.body.style.removeProperty('overflow');\n                        document.body.style.removeProperty('padding-right');\n                    }\n                }\n            });\n        });\n\n        observer.observe(document.body, {\n            attributes: true,\n            attributeFilter: ['style']\n        });\n        return observer;\n    }\n\n    /**\n     * Renders the subcomponents of the main component.\n     */\n    async _renderSubComponents() {\n        // Title area is not a component itself, so we cannot use this.renderComponent here.\n        const titleAreaPlaceholder = document.createElement('div');\n        this.getElement(this.selectors.TITLEAREA_PLACEHOLDER).appendChild(titleAreaPlaceholder);\n        const titleAreaComponent = await this.renderComponent(titleAreaPlaceholder, 'block_ai_chat/components/titlearea', {\n            showPersona: this.reactive.state.static.showPersona,\n            showOptions: this.reactive.state.static.showOptions,\n            showAgentMode: this.reactive.state.static.renderMode === RENDER_MODE.MODAL\n                ? this.reactive.state.static.showAgentMode\n                : false,\n            showViews: this.reactive.state.static.renderMode === RENDER_MODE.MODAL\n        });\n        this.getElement(this.selectors.TITLEAREA_PLACEHOLDER).replaceWith(titleAreaComponent.getElement());\n        titleAreaPlaceholder.remove();\n\n        const placeholderChatarea = document.createElement('div');\n        this.getElement(this.selectors.CONTENTAREA).appendChild(placeholderChatarea);\n        const chatComponent = await this.renderComponent(placeholderChatarea, 'block_ai_chat/components/chat', {});\n        this.getElement(this.selectors.CONTENTAREA).appendChild(chatComponent.getElement());\n        placeholderChatarea.remove();\n\n        const placeholderHistory = document.createElement('div');\n        this.getElement(this.selectors.CONTENTAREA).appendChild(placeholderHistory);\n        const historyComponent = await this.renderComponent(placeholderHistory, 'block_ai_chat/components/history', {});\n        this.getElement(this.selectors.CONTENTAREA).appendChild(historyComponent.getElement());\n        placeholderHistory.remove();\n\n        const placeholderPersonalist = document.createElement('div');\n        this.getElement(this.selectors.CONTENTAREA).appendChild(placeholderPersonalist);\n        const personaListComponent = await this.renderComponent(placeholderPersonalist, 'block_ai_chat/components/personalist', {});\n        this.getElement(this.selectors.CONTENTAREA).appendChild(personaListComponent.getElement());\n        placeholderPersonalist.remove();\n    }\n}\n\nexport default Main;\n"],"names":["Main","BaseComponent","create","descriptor","modal","name","classes","WINDOWMODE_WINDOW","WINDOWMODE_OPENFULL","WINDOWMODE_DOCKRIGHT","selectors","CONTENTAREA","TITLEAREA_PLACEHOLDER","state","this","_renderSubComponents","static","renderMode","RENDER_MODE","MODAL","getElement","closest","classList","add","document","getElementById","addEventListener","async","reactive","dispatch","getRoot","on","ModalEvents","hidden","config","modalVisible","outsideClick","event","preventDefault","storedWindowMode","_getLastWindowModeFromLocalStorage","window","innerWidth","bodyObserver","_setupOverflowWatcher","html","js","Templates","renderForPromise","prependNodeContents","destroy","disconnect","getWatchers","watch","handler","_handleWindowModeUpdated","_storeWindowModeToLocalStorage","_toggleModalVisibility","element","body","querySelector","Array","from","Object","values","forEach","classname","remove","windowModeClass","windowMode","key","userid","currentValue","LocalStorage","get","set","EMBEDDED","show","FocusLock","untrapFocus","hide","observer","MutationObserver","mutations","mutation","type","attributeName","getComputedStyle","overflow","style","removeProperty","observe","attributes","attributeFilter","titleAreaPlaceholder","createElement","appendChild","titleAreaComponent","renderComponent","showPersona","showOptions","showAgentMode","showViews","replaceWith","placeholderChatarea","chatComponent","placeholderHistory","historyComponent","placeholderPersonalist","personaListComponent"],"mappings":"4hDAuBMA,aAAaC,wBAEfC,OAAOC,iBACEC,MAAQD,WAAWC,WACnBC,KAAO,qBAEPC,QAAU,CACXC,kBAAmB,2BACnBC,oBAAqB,yBACrBC,qBAAsB,gCAErBC,UAAY,CACbC,2DACAC,8FAWSC,gBACPC,KAAKC,uBAEPF,MAAMG,OAAOC,aAAeC,uBAAYC,MAAO,MAC1CC,aAAaC,QAAQ,UAAUC,UAAUC,IAAI,uBAGnCC,SAASC,eAAe,kBAChCC,iBAAiB,aAAaC,eAC5BC,SAASC,SAAS,8BAOtBzB,MAAM0B,UAAUC,GAAGC,sBAAYC,QAAQ,KACpCpB,MAAMqB,OAAOC,mBACRP,SAASC,SAAS,sBAAsB,WAIhDzB,MAAM0B,UAAUC,GAAGC,sBAAYI,cAAcC,QAC9CA,MAAMC,wBAENC,uBAAyBzB,KAAK0B,qCACT,WAArBD,kBAAiCE,OAAOC,YAAc,MACtDH,iBAAmB,iBAElBX,SAASC,SAAS,gBAAiBU,uBACnCI,aAAe7B,KAAK8B,6BAEpBhB,SAASC,SAAS,sBAAsB,SAQ3CgB,KAACA,KAADC,GAAOA,UAAYC,mBAAUC,iBAAiB,8BAA+B,uBACzEC,oBAAoBnC,KAAKM,WAAWN,KAAKJ,UAAUC,aAAckC,KAAMC,IAGrFI,UACQpC,KAAK6B,mBACAA,aAAaQ,aAI1BC,oBACW,CACH,CAACC,kCAAoCC,QAASxC,KAAKyC,0BACnD,CAACF,kCAAoCC,QAASxC,KAAK0C,gCACnD,CAACH,oCAAsCC,QAASxC,KAAK2C,kEAI9BC,QAACA,oBACtBC,KAAOnC,SAASoC,cAAc,QACpCC,MAAMC,KAAKC,OAAOC,OAAOlD,KAAKR,UAAU2D,SAASC,YAC7CP,KAAKrC,UAAU6C,OAAOD,kBAEtBE,gBAAkB,YACdV,QAAQW,gBACP,SACDD,gBAAkBtD,KAAKR,QAAQC,4BAE9B,WACD6D,gBAAkBtD,KAAKR,QAAQE,8BAE9B,YACD4D,gBAAkBtD,KAAKR,QAAQG,qBAGvCkD,KAAKrC,UAAUC,IAAI6C,kEAIbE,UAAY,eAAK,WAAaxD,KAAKc,SAASf,MAAMG,OAAOuD,QAEzDC,aAAeC,sBAAaC,IAAIJ,YAC/BE,cAA8B,sDAI/BF,UAAY,eAAK,WAAaxD,KAAKc,SAASf,MAAMG,OAAOuD,8BAClDI,IAAIL,IAAKxD,KAAKc,SAASf,MAAMqB,OAAOmC,oDAGxBX,QAACA,eACtB5C,KAAKc,SAASf,MAAMG,OAAOC,aAAeC,uBAAY0D,WAGtDlB,QAAQvB,oBACFrB,KAAKV,MAAMyE,OAEjBC,UAAUC,cACVvD,SAASmC,KAAKrC,UAAUC,IAAI,8BAEtBT,KAAKV,MAAM4E,OACjBxD,SAASmC,KAAKrC,UAAU6C,OAAO,wBAgBvCvB,8BACUqC,SAAW,IAAIC,kBAAkBC,YACnCA,UAAUlB,SAASmB,cACO,eAAlBA,SAASC,MAAoD,UAA3BD,SAASE,cAA2B,OAChE3B,KAAOnC,SAASmC,KAGS,WAFTlB,OAAO8C,iBAAiB5B,MAE5B6B,UAAyB1E,KAAKc,SAASf,MAAMqB,OAAOC,eAClEX,SAASmC,KAAK8B,MAAMC,eAAe,YACnClE,SAASmC,KAAK8B,MAAMC,eAAe,gCAMnDT,SAASU,QAAQnE,SAASmC,KAAM,CAC5BiC,YAAY,EACZC,gBAAiB,CAAC,WAEfZ,4CAQDa,qBAAuBtE,SAASuE,cAAc,YAC/C3E,WAAWN,KAAKJ,UAAUE,uBAAuBoF,YAAYF,4BAC5DG,yBAA2BnF,KAAKoF,gBAAgBJ,qBAAsB,qCAAsC,CAC9GK,YAAarF,KAAKc,SAASf,MAAMG,OAAOmF,YACxCC,YAAatF,KAAKc,SAASf,MAAMG,OAAOoF,YACxCC,cAAevF,KAAKc,SAASf,MAAMG,OAAOC,aAAeC,uBAAYC,OAC/DL,KAAKc,SAASf,MAAMG,OAAOqF,cAEjCC,UAAWxF,KAAKc,SAASf,MAAMG,OAAOC,aAAeC,uBAAYC,aAEhEC,WAAWN,KAAKJ,UAAUE,uBAAuB2F,YAAYN,mBAAmB7E,cACrF0E,qBAAqB3B,eAEfqC,oBAAsBhF,SAASuE,cAAc,YAC9C3E,WAAWN,KAAKJ,UAAUC,aAAaqF,YAAYQ,2BAClDC,oBAAsB3F,KAAKoF,gBAAgBM,oBAAqB,gCAAiC,SAClGpF,WAAWN,KAAKJ,UAAUC,aAAaqF,YAAYS,cAAcrF,cACtEoF,oBAAoBrC,eAEduC,mBAAqBlF,SAASuE,cAAc,YAC7C3E,WAAWN,KAAKJ,UAAUC,aAAaqF,YAAYU,0BAClDC,uBAAyB7F,KAAKoF,gBAAgBQ,mBAAoB,mCAAoC,SACvGtF,WAAWN,KAAKJ,UAAUC,aAAaqF,YAAYW,iBAAiBvF,cACzEsF,mBAAmBvC,eAEbyC,uBAAyBpF,SAASuE,cAAc,YACjD3E,WAAWN,KAAKJ,UAAUC,aAAaqF,YAAYY,8BAClDC,2BAA6B/F,KAAKoF,gBAAgBU,uBAAwB,uCAAwC,SACnHxF,WAAWN,KAAKJ,UAAUC,aAAaqF,YAAYa,qBAAqBzF,cAC7EwF,uBAAuBzC,uBAIhBnE"}