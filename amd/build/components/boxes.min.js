define("block_ai_chat/components/boxes",["exports","core/reactive","local_ai_manager/infobox","local_ai_manager/warningbox","block_ai_chat/events"],(function(_exports,_reactive,_infobox,_warningbox,_events){Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.default=void 0;class Boxes extends _reactive.BaseComponent{static init(target){return new this({element:document.querySelector(target)})}create(){this.name="userquota",this.selectors={INFOBOX:"[data-block_ai_chat-element='ai_manager-infobox']",WARNINGBOX:"[data-block_ai_chat-element='ai_manager-warningbox']",CHAT_OUTPUT_WRAPPER:"[data-block_ai_chat-element='outputwrapper']"},this.HIDE_CLASS="block_ai_chat-scroll-hide",this._scrollListenerAttached=!1,window.console.log("[Boxes] create() called")}getWatchers(){return[{watch:"config.view:updated",handler:this._showOrHideBoxes},{watch:"config.currentConversationId:updated",handler:this._onConversationChanged}]}async stateReady(){window.console.log("[Boxes] stateReady() called"),await this._renderBoxes(),this._showOrHideBoxes();const modal=this.element.closest(".block_ai_chat_reactive_main_component");modal&&this.addEventListener(modal,_events.eventTypes.chatContentRendered,(()=>this._onChatContentRendered()))}_onChatContentRendered(){window.console.log("[Boxes] Chat content rendered event received"),this._scrollListenerAttached=!1,this._attachScrollListener()}_attachScrollListener(){if(this._scrollListenerAttached)return void window.console.log("[Boxes] Scroll listener already attached, skipping");const modal=this.element.closest(".block_ai_chat_reactive_main_component");if(!modal)return void window.console.log("[Boxes] Could not find modal container");const chatOutputWrapper=modal.querySelector(this.selectors.CHAT_OUTPUT_WRAPPER);chatOutputWrapper?this._attachScrollListenerToElement(chatOutputWrapper):window.console.log("[Boxes] Chat output not rendered yet, waiting for chatContentRendered event")}_attachScrollListenerToElement(chatOutputWrapper){this._scrollListenerAttached||(window.console.log("[Boxes] Attaching scroll listener to:",chatOutputWrapper),this._ignoreScrollEvents=!0,setTimeout((()=>{this._ignoreScrollEvents=!1,this._lastScrollTop=chatOutputWrapper.scrollTop,window.console.log("[Boxes] Scroll detection enabled, initial scrollTop:",this._lastScrollTop)}),500),this.addEventListener(chatOutputWrapper,"scroll",(()=>this._onScroll(chatOutputWrapper))),this._scrollListenerAttached=!0)}_onScroll(chatOutputWrapper){if(this._ignoreScrollEvents)return void window.console.log("[Boxes] Ignoring scroll event during initial layout");const hasVisibleScrollbar=chatOutputWrapper.scrollHeight>chatOutputWrapper.clientHeight,distanceFromBottom=chatOutputWrapper.scrollHeight-chatOutputWrapper.scrollTop-chatOutputWrapper.clientHeight,isAtBottom=distanceFromBottom<10;window.console.log("[Boxes] Scroll event fired!",{scrollTop:chatOutputWrapper.scrollTop,scrollHeight:chatOutputWrapper.scrollHeight,clientHeight:chatOutputWrapper.clientHeight,distanceFromBottom:distanceFromBottom,isAtBottom:isAtBottom,hasVisibleScrollbar:hasVisibleScrollbar}),hasVisibleScrollbar&&!isAtBottom&&(window.console.log("[Boxes] Hiding boxes - user scrolled away from bottom"),this.element.classList.add(this.HIDE_CLASS))}async _renderBoxes(){await(0,_infobox.renderInfoBox)("block_ai_chat",this.reactive.state.config.userid,this.getElement(this.selectors.INFOBOX),["chat"]),await(0,_warningbox.renderWarningBox)(this.getElement(this.selectors.WARNINGBOX))}_showOrHideBoxes(){"chat"===this.reactive.state.config.view?(this.element.classList.remove("d-none",this.HIDE_CLASS),this._scrollListenerAttached=!1,this._attachScrollListener()):this.element.classList.add("d-none")}_onConversationChanged(){window.console.log("[Boxes] Conversation changed, resetting boxes",{view:this.reactive.state.config.view,conversationId:this.reactive.state.config.currentConversationId,scrollListenerAttached:this._scrollListenerAttached}),"chat"===this.reactive.state.config.view&&(this.element.classList.remove(this.HIDE_CLASS),this._scrollListenerAttached=!1,this._attachScrollListener())}}var _default=Boxes;return _exports.default=_default,_exports.default}));

//# sourceMappingURL=boxes.min.js.map