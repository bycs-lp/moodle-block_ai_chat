{"version":3,"file":"history.min.js","sources":["../../src/components/history.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\nimport BaseContent from 'block_ai_chat/components/base_content';\nimport {getString} from 'core/str';\nimport Templates from 'core/templates';\nimport {callExternalFunction} from 'block_ai_chat/utils';\n\n/**\n * History component.\n */\nclass History extends BaseContent {\n\n    /**\n     * Function to initialize component, called by mustache template.\n     *\n     * @param {*} target The id of the HTMLElement to attach to\n     * @returns {BaseComponent} New component attached to the HTMLElement represented by target\n     */\n    static init(target) {\n        let element = document.querySelector(target);\n        return new this({\n            element: element,\n        });\n    }\n\n    create() {\n        this.selectors = {\n            NEW_DIALOG_BUTTON: `[data-block_ai_chat-element='newdialogbutton']`,\n            CONVERSATIONLIST_ITEM: `[data-block_ai_chat-element='conversationlistitem']`,\n        };\n    }\n\n    stateReady() {\n        this._hideContent();\n    }\n\n    _newDialogListener() {\n        this.reactive.dispatch('createAndViewNewConversation');\n    }\n\n    async _renderContent() {\n        // Iterate over conversations and group by date.\n        let groupedByDate = {};\n        const conversationlist = await callExternalFunction('block_ai_chat_get_all_conversations', {\n            contextid: this.reactive.state.static.contextid\n        });\n        if (conversationlist === null) {\n            return;\n        }\n\n        const strToday = await getString('today', 'core');\n        const strYesterday = await getString('yesterday', 'block_ai_chat');\n        conversationlist.forEach((convo) => {\n\n            // Get date and sort convos into a date array.\n            const now = new Date();\n            const date = new Date(convo.timecreated * 1000);\n            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());\n            const yesterday = new Date(now.getFullYear(), now.getMonth(), now.getDate() - 1);\n            const twoWeeksAgo = new Date(now);\n            twoWeeksAgo.setDate(now.getDate() - 14);\n\n            const options = {weekday: 'long', day: '2-digit', month: '2-digit'};\n            const monthOptions = {month: 'long', year: '2-digit'};\n\n            // Create a date string.\n            let dateString = '';\n            if (date >= today) {\n                dateString = strToday;\n            } else if (date >= yesterday) {\n                dateString = strYesterday;\n            } else if (date >= twoWeeksAgo) {\n                dateString = date.toLocaleDateString(undefined, options);\n            } else {\n                dateString = date.toLocaleDateString(undefined, monthOptions);\n            }\n\n            // Create a time string.\n            const hours = date.getHours();\n            const minutes = date.getMinutes().toString().padStart(2, '0');\n\n            let convItem = {\n                title: convo.title,\n                conversationid: convo.conversationid,\n                time: hours + ':' + minutes,\n            };\n\n            // Save entry under the date.\n            if (!groupedByDate[dateString]) {\n                groupedByDate[dateString] = [];\n            }\n            groupedByDate[dateString].push(convItem);\n        });\n\n        // Convert the grouped objects into an array format that Mustache can iterate over.\n        let convert = {\n            groups: Object.keys(groupedByDate).map(key => ({\n                key: key,\n                objects: groupedByDate[key]\n            }))\n        };\n\n        // Render history.\n        const templateData = {\n            dates: convert.groups,\n        };\n        const {html, js} = await Templates.renderForPromise('block_ai_chat/history_content', templateData);\n        Templates.replaceNodeContents(this.getElement(), html, js);\n        await this._setupafterContentRendering();\n    }\n\n    _setupafterContentRendering() {\n        this.addEventListener(\n            this.getElement(this.selectors.NEW_DIALOG_BUTTON),\n            'click',\n            this._newDialogListener\n        );\n        this.getElement().querySelectorAll(this.selectors.CONVERSATIONLIST_ITEM).forEach((conversationlistItem) => {\n            this.addEventListener(conversationlistItem, 'click', () => {\n                const conversationid = conversationlistItem.dataset.block_ai_chatConversationid;\n                this.reactive.dispatch('setConversationAndLoadChat', conversationid);\n            });\n        });\n    }\n\n    getViewName() {\n        return 'history';\n    }\n}\n\nexport default History;"],"names":["History","BaseContent","target","this","element","document","querySelector","create","selectors","NEW_DIALOG_BUTTON","CONVERSATIONLIST_ITEM","stateReady","_hideContent","_newDialogListener","reactive","dispatch","groupedByDate","conversationlist","contextid","state","static","strToday","strYesterday","forEach","convo","now","Date","date","timecreated","today","getFullYear","getMonth","getDate","yesterday","twoWeeksAgo","setDate","options","weekday","day","month","monthOptions","year","dateString","toLocaleDateString","undefined","hours","getHours","minutes","getMinutes","toString","padStart","convItem","title","conversationid","time","push","templateData","dates","groups","Object","keys","map","key","objects","html","js","Templates","renderForPromise","replaceNodeContents","getElement","_setupafterContentRendering","addEventListener","querySelectorAll","conversationlistItem","dataset","block_ai_chatConversationid","getViewName"],"mappings":"mdAuBMA,gBAAgBC,kCAQNC,eAED,IAAIC,KAAK,CACZC,QAFUC,SAASC,cAAcJ,UAMzCK,cACSC,UAAY,CACbC,mEACAC,6EAIRC,kBACSC,eAGTC,0BACSC,SAASC,SAAS,2DAKnBC,cAAgB,SACdC,uBAAyB,+BAAqB,sCAAuC,CACvFC,UAAWf,KAAKW,SAASK,MAAMC,OAAOF,eAEjB,OAArBD,8BAIEI,eAAiB,kBAAU,QAAS,QACpCC,mBAAqB,kBAAU,YAAa,iBAClDL,iBAAiBM,SAASC,cAGhBC,IAAM,IAAIC,KACVC,KAAO,IAAID,KAAyB,IAApBF,MAAMI,aACtBC,MAAQ,IAAIH,KAAKD,IAAIK,cAAeL,IAAIM,WAAYN,IAAIO,WACxDC,UAAY,IAAIP,KAAKD,IAAIK,cAAeL,IAAIM,WAAYN,IAAIO,UAAY,GACxEE,YAAc,IAAIR,KAAKD,KAC7BS,YAAYC,QAAQV,IAAIO,UAAY,UAE9BI,QAAU,CAACC,QAAS,OAAQC,IAAK,UAAWC,MAAO,WACnDC,aAAe,CAACD,MAAO,OAAQE,KAAM,eAGvCC,WAAa,GAEbA,WADAf,MAAQE,MACKR,SACNM,MAAQM,UACFX,aACNK,MAAQO,YACFP,KAAKgB,wBAAmBC,EAAWR,SAEnCT,KAAKgB,wBAAmBC,EAAWJ,oBAI9CK,MAAQlB,KAAKmB,WACbC,QAAUpB,KAAKqB,aAAaC,WAAWC,SAAS,EAAG,SAErDC,SAAW,CACXC,MAAO5B,MAAM4B,MACbC,eAAgB7B,MAAM6B,eACtBC,KAAMT,MAAQ,IAAME,SAInB/B,cAAc0B,cACf1B,cAAc0B,YAAc,IAEhC1B,cAAc0B,YAAYa,KAAKJ,mBAY7BK,aAAe,CACjBC,MATU,CACVC,OAAQC,OAAOC,KAAK5C,eAAe6C,KAAIC,OACnCA,IAAKA,IACLC,QAAS/C,cAAc8C,UAMZJ,SAEbM,KAACA,KAADC,GAAOA,UAAYC,mBAAUC,iBAAiB,gCAAiCX,iCAC3EY,oBAAoBjE,KAAKkE,aAAcL,KAAMC,UACjD9D,KAAKmE,8BAGfA,mCACSC,iBACDpE,KAAKkE,WAAWlE,KAAKK,UAAUC,mBAC/B,QACAN,KAAKU,yBAEJwD,aAAaG,iBAAiBrE,KAAKK,UAAUE,uBAAuBa,SAASkD,4BACzEF,iBAAiBE,qBAAsB,SAAS,WAC3CpB,eAAiBoB,qBAAqBC,QAAQC,iCAC/C7D,SAASC,SAAS,6BAA8BsC,sBAKjEuB,oBACW,wBAIA5E"}