{"version":3,"file":"historymarker.min.js","sources":["../../src/components/historymarker.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\nimport Popover from 'theme_boost/bootstrap/popover';\nimport {BaseComponent} from 'core/reactive';\n\n\nclass HistoryMarker extends BaseComponent {\n\n    /**\n     * Function to initialize component, called by mustache template.\n     *\n     * @param {*} target The id of the HTMLElement to attach to\n     * @returns {BaseComponent} New component attached to the HTMLElement represented by target\n     */\n    static init(target) {\n        let element = document.querySelector(target);\n        return new this({\n            element: element,\n        });\n    }\n\n    /**\n     * It is important to follow some conventions while you write components. This way all components\n     * will be implemented in a similar way and anybody will be able to understand how it works.\n     *\n     * All the component definition should be initialized on the \"create\" method.\n     */\n    create() {\n        this.name = 'HistoryMarker';\n        this.selectors = {\n            MESSAGES: `[data-block_ai_chat-element='messages']`,\n            MESSAGE: `[data-block_ai_chat-component='message']`,\n            HISTORY_MARKER_CONTENT: `[data-block_ai_chat-element='historymarkercontent']`,\n        };\n    }\n\n    /**\n     * Initial state ready method.\n     *\n     * Initially calls the setView action to set the view to 'chat' once ready to trigger the first\n     * rendering of itself.\n     */\n    async stateReady() {\n        // Initialize the popover.\n        const historyMarkerContent = this.getElement(this.selectors.HISTORY_MARKER_CONTENT);\n        if (historyMarkerContent) {\n            new Popover(historyMarkerContent);\n        }\n        this._updatePositionAndVisibility();\n    }\n\n    getWatchers() {\n        return [\n            {watch: `messages.rendered:updated`, handler: this._updatePositionAndVisibility},\n            {watch: `messages:deleted`, handler: this._updatePositionAndVisibility},\n            {watch: `config.conversationContextLimit:updated`, handler: this._updatePositionAndVisibility},\n        ];\n    }\n\n    _updatePositionAndVisibility() {\n        const chatOutputContainer = this.getElement().parentElement;\n\n        const messages = this.reactive.state.messages;\n        const contextLimit = this.reactive.state.config.conversationContextLimit;\n\n        // Context limit of n means we fetch the latest n records from the database, each containing a prompt\n        // and a prompt response. In the frontend however each prompt and promptcompletion is a separate message.\n        // So we need at least 2 * n messages to show the marker.\n        if (messages.size <= 2 * contextLimit) {\n            this._hide();\n            return;\n        }\n\n        // Set correct marker value:\n        this.getElement(this.selectors.HISTORY_MARKER_CONTENT).textContent = contextLimit;\n\n        // Marker position: after message at index (length - 2 * contextLimit - 1).\n        // History length of 4 messages actually means 4 user messages and 4 AI messages = 8 messages total.\n        const markerPosition = messages.size - 2 * contextLimit - 1;\n        const messageId = Array.from(messages.values())[markerPosition].id;\n        const messageBeforeContext = chatOutputContainer.querySelector(\n            this.selectors.MESSAGE + `[data-block_ai_chat-messageid=\"${messageId}\"]`\n        );\n\n        if (!messageBeforeContext) {\n            // DOM element not found yet - event listener will call us again when it's ready.\n            return;\n        }\n\n        // Check if the message element is a direct child of the chat output container.\n        // If not, it's still inside a placeholder div - event listener will call us again after replaceChild.\n        if (messageBeforeContext.parentElement !== chatOutputContainer) {\n            return;\n        }\n\n        this._show();\n        messageBeforeContext.after(this.getElement());\n    }\n\n    _hide() {\n        this.getElement().classList.add('d-none');\n    }\n\n    _show() {\n        this.getElement().classList.remove('d-none');\n    }\n}\n\nexport default HistoryMarker;\n"],"names":["HistoryMarker","BaseComponent","target","this","element","document","querySelector","create","name","selectors","MESSAGES","MESSAGE","HISTORY_MARKER_CONTENT","historyMarkerContent","getElement","Popover","_updatePositionAndVisibility","getWatchers","watch","handler","chatOutputContainer","parentElement","messages","reactive","state","contextLimit","config","conversationContextLimit","size","_hide","textContent","markerPosition","messageId","Array","from","values","id","messageBeforeContext","_show","after","classList","add","remove"],"mappings":"2SAmBMA,sBAAsBC,oCAQZC,eAED,IAAIC,KAAK,CACZC,QAFUC,SAASC,cAAcJ,UAYzCK,cACSC,KAAO,qBACPC,UAAY,CACbC,mDACAC,mDACAC,uGAYEC,qBAAuBV,KAAKW,WAAWX,KAAKM,UAAUG,wBACxDC,0BACIE,iBAAQF,2BAEXG,+BAGTC,oBACW,CACH,CAACC,kCAAoCC,QAAShB,KAAKa,8BACnD,CAACE,yBAA2BC,QAAShB,KAAKa,8BAC1C,CAACE,gDAAkDC,QAAShB,KAAKa,+BAIzEA,qCACUI,oBAAsBjB,KAAKW,aAAaO,cAExCC,SAAWnB,KAAKoB,SAASC,MAAMF,SAC/BG,aAAetB,KAAKoB,SAASC,MAAME,OAAOC,4BAK5CL,SAASM,MAAQ,EAAIH,8BAChBI,aAKJf,WAAWX,KAAKM,UAAUG,wBAAwBkB,YAAcL,mBAI/DM,eAAiBT,SAASM,KAAO,EAAIH,aAAe,EACpDO,UAAYC,MAAMC,KAAKZ,SAASa,UAAUJ,gBAAgBK,GAC1DC,qBAAuBjB,oBAAoBd,cAC7CH,KAAKM,UAAUE,iDAA4CqB,iBAG1DK,sBAODA,qBAAqBhB,gBAAkBD,2BAItCkB,QACLD,qBAAqBE,MAAMpC,KAAKW,eAGpCe,aACSf,aAAa0B,UAAUC,IAAI,UAGpCH,aACSxB,aAAa0B,UAAUE,OAAO,wBAI5B1C"}