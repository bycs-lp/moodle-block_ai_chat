{"version":3,"file":"dialog.min.js","sources":["../src/dialog.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\nimport Modal from 'core/modal';\nimport * as externalServices from 'block_ai_chat/webservices';\nimport Templates from 'core/templates';\nimport {\n    alert as displayAlert, exception as displayException, deleteCancelPromise,\n    confirm as confirmModal\n} from 'core/notification';\nimport SaveCancelModal from 'core/modal_save_cancel';\nimport ModalEvents from 'core/modal_events';\nimport ModalForm from 'core_form/modalform';\nimport * as helper from 'block_ai_chat/helper';\nimport * as manager from 'block_ai_chat/ai_manager';\nimport {getString} from 'core/str';\nimport {renderInfoBox} from 'local_ai_manager/infobox';\nimport {renderUserQuota} from 'local_ai_manager/userquota';\nimport {renderWarningBox} from 'local_ai_manager/warningbox';\nimport {getAiConfig} from 'local_ai_manager/config';\nimport LocalStorage from 'core/localstorage';\nimport {escapeHTML, hash, scrollToBottom} from './helper';\nimport * as TinyAiUtils from 'tiny_ai/utils';\nimport TinyAiEditorUtils from 'tiny_ai/editor_utils';\nimport {constants as TinyAiConstants} from 'tiny_ai/constants';\nimport * as DomExtractor from 'block_ai_chat/dom_extractor';\nimport {extractDomElements} from \"block_ai_chat/dom_extractor\";\n\n// Declare variables.\nconst VIEW_CHATWINDOW = 'block_ai_chat_chatwindow';\nconst VIEW_OPENFULL = 'block_ai_chat_openfull';\nconst VIEW_DOCKRIGHT = 'block_ai_chat_dockright';\nconst MODAL_OPEN = 'block_ai_chat_open';\n\n// Modal.\nlet modal = {};\nlet strHistory;\nlet strNewDialog;\nlet strToday;\nlet strYesterday;\nlet strDefinePersona;\nlet strNewPersona;\nlet strUserTemplates;\nlet strSystemTemplates;\nlet personaForm = {};\nlet personaPrompt = '';\nlet personaInfo = '';\nlet personaLink = '';\nlet personaNewname = {};\nlet personaButtondelete = {};\nlet personaUserinfo = {};\nlet personaInputprompt = {};\nlet systemTemplateHiddenInput = {};\nlet showPersona = false;\nlet optionsForm = {};\nlet showOptions = false;\nlet isAdmin = false;\nlet badge;\nlet viewmode;\nlet modalopen = false;\n\n// Current conversation.\nlet conversation = {\n    id: 0,\n    messages: [],\n};\n// All conversations.\nlet allConversations = [];\n// Userid.\nlet userid = 0;\n// Block context id.\nlet contextid = 0;\n// First load.\nlet firstLoad = true;\n// AI in process of answering.\nlet aiAtWork = false;\n// Maximum history included in query, should be reset via webservice.\nlet maxHistory = 5;\n// Remember warnings for maximum history in this session.\nlet maxHistoryWarnings = new Set();\n// Tenantconfig.\nlet tenantConfig = {};\nlet chatConfig = {};\nlet agentMode = false;\n\nclass DialogModal extends Modal {\n    static TYPE = \"block_ai_chat/dialog_modal\";\n    static TEMPLATE = \"block_ai_chat/dialog_modal\";\n\n    configure(modalConfig) {\n        // Show this modal on instantiation.\n        modalConfig.show = false;\n\n        // Remove from the DOM on close.\n        modalConfig.removeOnClose = false;\n\n        modalConfig.isVerticallyCentered = false;\n\n        super.configure(modalConfig);\n    }\n\n    hide() {\n        super.hide();\n        // Keep track of state, to restrict changes to block_ai_chat modal.\n        modalopen = false;\n        const body = document.querySelector('body');\n        body.classList.remove(MODAL_OPEN);\n    }\n}\n\nexport const init = async (params) => {\n    // Read params.\n    userid = params.userid;\n    contextid = params.contextid;\n    strNewDialog = params.new;\n    strHistory = params.history;\n    strDefinePersona = params.persona;\n    strNewPersona = params.newpersona;\n    strUserTemplates = params.usertemplates;\n    strSystemTemplates = params.systemtemplates;\n    personaPrompt = params.personaprompt;\n    personaInfo = params.personainfo;\n    showPersona = params.showpersona;\n    showOptions = params.showoptions;\n    personaLink = params.personalink;\n    isAdmin = params.isadmin;\n    badge = params.badge;\n    // Disable badge.\n    badge = false;\n\n    // Get configuration.\n    const aiConfig = await getAiConfig(contextid, null, ['chat', 'agent']);\n    tenantConfig = aiConfig;\n    chatConfig = aiConfig.purposes[0];\n\n    const agentString = await getString('agentmode', 'block_ai_chat');\n    // Build chat dialog modal.\n    modal = await DialogModal.create({\n        templateContext: {\n            identifier: 'agent-toggle',\n            checked: agentMode,\n            text: agentString,\n            title: strNewDialog,\n            badge: badge,\n            showPersona: showPersona,\n            showOptions: showOptions,\n        },\n    });\n\n    // Add class for styling when modal is displayed.\n    modal.getRoot().on('modal:shown', function (e) {\n        e.target.classList.add(\"block_ai_chat_modal\");\n    });\n\n    // Conditionally prevent outside click event.\n    modal.getRoot().on(ModalEvents.outsideClick, event => {\n        checkOutsideClick(event);\n    });\n\n    // Check and set viewmode.\n    setView();\n\n    // Attach listener to the ai button to call modal.\n    let button = document.getElementById('ai_chat_button');\n    button.addEventListener('mousedown', async () => {\n        await showModal(params);\n    });\n\n    // Get strings.\n    strToday = await getString('today', 'core');\n    strYesterday = await getString('yesterday', 'block_ai_chat');\n\n    // Create a MediaQueryList object to check for small screens.\n    const mediaQuery = window.matchMedia(\"(max-width: 576px)\");\n\n    // Attach the event listener to handle changes.\n    mediaQuery.addEventListener('change', handleScreenWidthChange);\n\n    // Initial check for screenwidth.\n    if (window.innerWidth <= 576) {\n        setView(VIEW_OPENFULL);\n    }\n};\n\n/**\n * Show ai_chat modal.\n */\nasync function showModal() {\n    console.log(\"SHOW MODAL\")\n    // Switch for repeated clicking.\n    if (modalopen) {\n        modal.hide();\n        return;\n    }\n\n    // Show modal.\n    await modal.show();\n    modalopen = true;\n    const body = document.querySelector('body');\n    body.classList.add(MODAL_OPEN);\n    // Moodle core adds a overflow: \"hidden\" to the body when opening a modal to prevent scrolling outside the modal.\n    // We however need exactly that, so we manipulate it back again.\n    // As a workaround we set this every second.\n    // TODO REMOVE THIS WORKAROUND\n    setInterval(() => {\n        body.style.overflow = 'visible';\n    }, 1000);\n\n    // Add listener for input submission.\n    const textarea = document.getElementById('block_ai_chat-input-id');\n    addTextareaListener(textarea);\n    const button = document.getElementById('block_ai_chat-submit-id');\n    button.addEventListener(\"click\", (event) => {\n        clickSubmitButton(event);\n    });\n\n    if (firstLoad) {\n        firstLoad = false;\n        // Load conversations.\n        await getConversations();\n\n        // Show conversation.\n        await showConversation();\n\n        // Get conversationcontext message limit.\n        let reply = await externalServices.getConversationcontextLimit(contextid);\n        maxHistory = reply.limit;\n\n        // Add listener for agent mode toggle\n        const agentToggle = document.querySelector('[data-toggle-identifier=\"agent-toggle\"] input');\n        agentToggle.addEventListener('change', () => {\n            agentMode = !agentMode;\n        });\n\n        // Add listeners for dropdownmenus.\n        // Actions.\n        const btnNewDialog = document.getElementById('block_ai_chat_new_dialog');\n        btnNewDialog.addEventListener('click', () => {\n            newDialog();\n        });\n        const btnDeleteDialog = document.getElementById('block_ai_chat_delete_dialog');\n        btnDeleteDialog.addEventListener('click', () => {\n            deleteCurrentDialog();\n        });\n        const btnShowHistory = document.getElementById('block_ai_chat_show_history');\n        btnShowHistory.addEventListener('click', () => {\n            showHistory();\n        });\n        const btnDefinePersona = document.getElementById('block_ai_chat_define_persona');\n        if (btnDefinePersona) {\n            btnDefinePersona.addEventListener('click', async () => {\n                if (isAdmin) {\n                    await confirmModal(\n                        getString('notice', 'block_ai_chat'),\n                        getString('personasystemtemplateedit', 'block_ai_chat'),\n                        getString('confirm', 'core'),\n                        null,\n                        showPersonasModal,\n                        null\n                    );\n                } else {\n                    await showPersonasModal();\n                }\n            });\n        }\n        const btnOptions = document.getElementById('block_ai_chat_options');\n        if (btnOptions) {\n            btnOptions.addEventListener('click', () => {\n                showOptionsModal();\n            });\n        }\n        // Views.\n        const btnChatwindow = document.getElementById(VIEW_CHATWINDOW);\n        btnChatwindow.addEventListener('click', () => {\n            setView(VIEW_CHATWINDOW);\n        });\n        const btnFullWidth = document.getElementById(VIEW_OPENFULL);\n        btnFullWidth.addEventListener('click', () => {\n            setView(VIEW_OPENFULL);\n        });\n        const btnDockRight = document.getElementById(VIEW_DOCKRIGHT);\n        btnDockRight.addEventListener('click', () => {\n            setView(VIEW_DOCKRIGHT);\n        });\n\n        // Show userquota.\n        await renderUserQuota('#block_ai_chat_userquota', ['chat', 'agent']);\n        // Show infobox.\n        await renderInfoBox(\n            'block_ai_chat', userid, '.block_ai_chat_modal_body [data-content=\"local_ai_manager_infobox\"]', ['chat']\n        );\n        // Show ai info warning.\n        const warningBoxSelector = '.local_ai_manager-ai-warning';\n        if (document.querySelector(warningBoxSelector)) {\n            await renderWarningBox(warningBoxSelector);\n        }\n        // Show persona info.\n        if (personaPrompt !== '') {\n            showUserinfo(true);\n        }\n\n        // Check if all permissions and settings are correct.\n        const message = await userAllowed();\n        if (message !== '') {\n            const notice = await getString('notice', 'block_ai_chat');\n            await displayAlert(notice, message);\n        }\n\n        const aiUtilsButton = document.querySelector('[data-action=\"openaiutils\"]');\n        const uniqid = Math.random().toString(16).slice(2);\n\n        await TinyAiUtils.init(uniqid, contextid, TinyAiConstants.modalModes.standalone);\n        aiUtilsButton.addEventListener('click', async () => {\n            // We try to find selected text or images and inject it into the AI tools.\n            const selectionObject = window.getSelection();\n            if (selectionObject.rangeCount > 0) {\n                // Safari browser does not really comply with MDN standard and sometimes has\n                // rangeCount === 0. So we have to check for this to avoid running into an error.\n                const range = selectionObject.getRangeAt(0);\n                const container = document.createElement('div');\n                container.appendChild(range.cloneContents());\n                const images = container.querySelectorAll('img');\n                if (images.length > 0 && images[0].src) {\n                    // If there are more than one we just use the first one.\n                    const image = images[0];\n                    // This should work for both external and data urls.\n                    const fetchResult = await fetch(image.src);\n                    const data = await fetchResult.blob();\n                    TinyAiUtils.getDatamanager(uniqid).setSelectionImg(data);\n                }\n\n                // If currently there is text selected we inject it.\n                if (selectionObject.toString() && selectionObject.toString().length > 0) {\n                    TinyAiUtils.getDatamanager(uniqid).setSelection(selectionObject.toString());\n                }\n            }\n\n            const editorUtils = new TinyAiEditorUtils(uniqid, 'block_ai_chat', contextid, userid, null);\n            TinyAiUtils.setEditorUtils(uniqid, editorUtils);\n            await editorUtils.displayDialogue();\n        });\n\n    }\n\n    helper.focustextarea();\n}\n\n/**\n * Webservice Get all conversations.\n */\nconst getConversations = async () => {\n    try {\n        allConversations = await externalServices.getAllConversations(userid, contextid);\n    } catch (error) {\n        displayException(error);\n    }\n};\n\n/**\n * Function to set conversation.\n * @param {*} id\n */\nconst showConversation = async (id = 0) => {\n    // Dissallow changing conversations when question running.\n    if (aiAtWork) {\n        return;\n    }\n    // Change conversation or get last conversation.\n    if (id !== 0) {\n        // Set selected conversation.\n        conversation = allConversations.find(x => x.id === id);\n    } else if (typeof allConversations[0] !== 'undefined') {\n        // Set last conversation.\n        conversation = allConversations.at(allConversations.length - 1);\n    } else if (allConversations.length === 0) {\n        // Last conversation has been deleted.\n        newDialog(true);\n    }\n    clearMessages();\n    setModalHeader();\n    await showMessages();\n};\n// Make globally accessible since it is used to show history in dropdownmenuitem.mustache.\ndocument.showConversation = showConversation;\n\n/**\n * Send input to ai connector.\n * @param {*} question\n */\nconst enterQuestion = async (question) => {\n\n    // Deny changing dialogs until answer present?\n    if (question == '') {\n        aiAtWork = false;\n        return;\n    }\n    const message = await userAllowed();\n    if (message !== '') {\n        const notice = await getString('noticenewquestion', 'block_ai_chat');\n        await displayAlert(notice, message);\n        aiAtWork = false;\n        return;\n    }\n\n    // Add to conversation, answer not yet available.\n    showMessage(question, 'self', false);\n\n    // For first message, add the personaprompt, even if empty.\n    // Since we dont know if the personaPrompt was changed, always replace it.\n    if (typeof conversation.messages[0] == 'undefined' || conversation.messages[0].sender !== 'system') {\n        conversation.messages.unshift({\n            'message': personaPrompt,\n            'sender': 'system'\n        });\n    } else {\n        // Replace personaPrompt.\n        conversation.messages[0] = {\n            'message': personaPrompt,\n            'sender': 'system'\n        };\n    }\n\n    // Check history for length limit.\n    let convHistory = await checkMessageHistoryLengthLimit(conversation.messages);\n\n    // Since some models cant handle an empty system message, remove from convHistory.\n    if (personaPrompt.trim() === '' && convHistory[0].sender === 'system') {\n        convHistory.shift();\n    }\n    // Options, with conversation history.\n    const options = {\n        'conversationcontext': convHistory\n    };\n\n    // For a new conversation, get an id.\n    if (conversation.id === 0) {\n        try {\n            let idresult = await externalServices.getNewConversationId(contextid);\n            conversation.id = idresult.id;\n            conversation.timecreated = Math.floor(Date.now() / 1000);\n            setModalHeader(escapeHTML(question));\n        } catch (error) {\n            displayException(error);\n        }\n        options.forcenewitemid = true;\n    }\n\n    // Pass itemid / conversationid.\n    options.itemid = conversation.id;\n\n    // Send to local_ai_manager.\n    options.agentoptions = {\n        formelements: DomExtractor.extractDomElements(),\n        pagedock: DomExtractor.extractPageDock(),\n        pageid: document.body.id\n    };\n\n    let requestresult;\n    let suggestionContext = null;\n    if (agentMode) {\n        // TODO Pass again the conversationcontext -> also apply purpose.\n        delete options.conversationcontext;\n        requestresult = await manager.askLocalAiManager('agent', question, contextid, options);\n        let agentAnswer = null;\n        try {\n            console.log(requestresult.result);\n            agentAnswer = JSON.parse(requestresult.result);\n            // If we have a parsable agent response there is no\n            requestresult.result = '';\n            console.log(agentAnswer)\n            const chatOutputIntroObject = agentAnswer.chatoutput.filter(object => object.type === 'intro')[0];\n            const chatOutputOutroObject = agentAnswer.chatoutput.filter(object => object.type === 'outro')[0];\n            suggestionContext = {\n                intro: chatOutputIntroObject.text,\n                suggestions: [],\n                outro: chatOutputOutroObject.text\n            };\n            console.log(suggestionContext)\n            agentAnswer.formelements.forEach(formElement => {\n                    const htmlElement = document.getElementById(formElement.id);\n                    console.log(htmlElement);\n                    console.log(htmlElement.tagName)\n                    console.log(formElement.new_value)\n\n                    console.log(htmlElement.value)\n                    console.log(formElement)\n                    const extractedDomElement = options.agentoptions.formelements.filter(element => element.id === formElement.id)[0];\n                    console.log(extractedDomElement)\n                    suggestionContext.suggestions.push({\n                        fieldname: extractedDomElement.label,\n                        explanation: formElement.explanation,\n                        elementId: formElement.id,\n                        suggestionvalue: formElement.new_value,\n                    });\n                }\n            );\n            console.log(suggestionContext)\n        } catch (error) {\n            console.log(error);\n        }\n        console.log(suggestionContext)\n    } else {\n        requestresult = await manager.askLocalAiManager('chat', question, contextid, options);\n    }\n\n    // Handle errors.\n    if (requestresult.code != 200) {\n        requestresult = await errorHandling(requestresult, question, contextid, options);\n    }\n\n    // Write back answer.\n    await showReply(requestresult.result, suggestionContext);\n    // Attach copy listener.\n    // TODO Not sure why this does not work, commented out for the moment\n    /*let copy = document.querySelector('.block_ai_chat_modal .awaitanswer .copy');\n    copy.addEventListener('mousedown', () => {\n        helper.copyToClipboard(copy);\n    });*/\n\n    // Render mathjax.\n    helper.renderMathjax();\n\n    // Ai is done.\n    aiAtWork = false;\n\n    // Save new question and answer.\n    if (requestresult.code == 200) {\n        // If new conversation, sanitize the prompt for modal title and history.\n        if (conversation.messages.length == 0) {\n            question = escapeHTML(question);\n        }\n        saveConversationLocally(question, requestresult.result);\n    }\n\n    // Update userquota.\n    const userquota = document.getElementById('block_ai_chat_userquota');\n    userquota.innerHTML = '';\n    renderUserQuota('#block_ai_chat_userquota', ['chat', 'agent']);\n};\n\n/**\n * Render reply.\n * @param {string} text\n */\nconst showReply = async (text, agentSuggestionsContext) => {\n    // Get textblock.\n    let fields = document.querySelectorAll('.block_ai_chat_modal .awaitanswer .text');\n    const field = fields[fields.length - 1];\n    // Render the reply.\n    console.log(agentSuggestionsContext);\n    let context = {text};\n    if (agentSuggestionsContext !== null) {\n        context = {\n            text,\n            ...agentSuggestionsContext\n        };\n    }\n    console.log(context)\n    const {html, js} = await Templates.renderForPromise('block_ai_chat/reply', context);\n    Templates.replaceNodeContents(field, html, js);\n    field.classList.remove('small');\n\n    // Remove awaitanswer class.\n    let awaitdivs = document.querySelectorAll('.block_ai_chat_modal .awaitanswer');\n    const awaitdiv = awaitdivs[awaitdivs.length - 1];\n    awaitdiv.classList.remove('awaitanswer');\n\n    // Check if answer is smaller than the viewport, if so scroll to bottom.\n    const container = document.querySelector('.block_ai_chat-output-wrapper');\n    if (field.scrollHeight < container.clientHeight) {\n        scrollToBottom();\n    }\n};\n\nconst showMessages = async () => {\n    for (const item of conversation.messages) {\n        await showMessage(item.message, item.sender);\n    }\n};\n\n/**\n * Show answer from local_ai_manager.\n * @param {*} text\n * @param {*} sender User or Ai\n * @param {*} answer Is answer in history\n */\nconst showMessage = async (text, sender = '', answer = true) => {\n    // Skip if sender is system.\n    if (sender === 'system') {\n        return;\n    }\n    // Imitate bool for message.mustache logic {{#sender}}.\n    if (sender === 'ai') {\n        sender = '';\n    }\n    // Escape chars for immediate rendering.\n    if (!answer) {\n        text = escapeHTML(text);\n    }\n\n    const templateData = {\n        \"sender\": sender,\n        \"content\": text,\n        \"answer\": answer,\n    };\n    // Call the function to load and render our template.\n    const {html, js} = await Templates.renderForPromise('block_ai_chat/message', templateData);\n    Templates.appendNodeContents('.block_ai_chat-output', html, js);\n\n    // Add copy listener for question and reply.\n    helper.attachCopyListenerLast();\n\n    // Scroll the modal content to the bottom.\n    helper.scrollToBottom();\n};\n\n/**\n * Create new / Reset dialog.\n * @param {bool} deleted\n */\nconst newDialog = async (deleted = false) => {\n    if (aiAtWork) {\n        return;\n    }\n    // Add current convo local representation, if not already there.\n    if (allConversations.find(x => x.id === conversation.id) === undefined && !deleted) {\n        allConversations.push(conversation);\n    }\n    // Reset local conservation.\n    conversation = {\n        id: 0,\n        messages: [],\n    };\n    clearMessages();\n    setModalHeader(strNewDialog);\n    helper.focustextarea();\n};\n\n/**\n * Delete /hide current dialog.\n */\nconst deleteCurrentDialog = () => {\n    deleteCancelPromise(\n        getString('delete', 'block_ai_chat'),\n        getString('deletewarning', 'block_ai_chat'),\n    ).then(async () => {\n        if (conversation.id !== 0) {\n            try {\n                const deleted = await externalServices.deleteConversation(contextid, userid, conversation.id);\n                if (deleted) {\n                    removeFromHistory();\n                    await showConversation();\n                }\n            } catch (error) {\n                displayException(error);\n            }\n        }\n        return;\n    }).catch(() => {\n        return;\n    });\n};\n\n/**\n * Show conversation history.\n */\nconst showHistory = async () => {\n    // Add current convo local representation, if not already there.\n    if (allConversations.find(x => x.id === conversation.id) === undefined) {\n        allConversations.push(conversation);\n    }\n    // Change title and add backlink.\n    let title = '<a href=\"#\" id=\"block_ai_chat_backlink\"><i class=\"icon fa fa-arrow-left\"></i>' + strHistory + '</a>';\n    clearMessages(true);\n    setModalHeader(title);\n    const btnBacklink = document.getElementById('block_ai_chat_backlink');\n    btnBacklink.addEventListener('click', async () => {\n        if (conversation.id !== 0) {\n            await showConversation(conversation.id);\n        } else {\n            newDialog();\n            clearMessages();\n        }\n        setModalHeader();\n    });\n\n    // Set modal class to hide info about ratelimits and infobox.\n    let modal = document.querySelector('.block_ai_chat_modal');\n    modal.classList.add('onhistorypage');\n\n    // Iterate over conversations and group by date.\n    let groupedByDate = {};\n    allConversations.forEach((convo) => {\n\n        if (typeof convo.messages[0] !== 'undefined') {\n            // Get first prompt for title.\n            let title = '';\n            if (convo.messages[0].sender == 'system') {\n                title = convo.messages[1].message;\n            } else {\n                title = convo.messages[0].message;\n            }\n\n            // Get date and sort convos into a date array.\n            const now = new Date();\n            const date = new Date(convo.timecreated * 1000);\n            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());\n            const yesterday = new Date(now.getFullYear(), now.getMonth(), now.getDate() - 1);\n            const twoWeeksAgo = new Date(now);\n            twoWeeksAgo.setDate(now.getDate() - 14);\n\n            const options = {weekday: 'long', day: '2-digit', month: '2-digit'};\n            const monthOptions = {month: 'long', year: '2-digit'};\n\n            // Create a date string.\n            let dateString = '';\n            if (date >= today) {\n                dateString = strToday;\n            } else if (date >= yesterday) {\n                dateString = strYesterday;\n            } else if (date >= twoWeeksAgo) {\n                dateString = date.toLocaleDateString(undefined, options);\n            } else {\n                dateString = date.toLocaleDateString(undefined, monthOptions);\n            }\n\n            // Create a time string.\n            const hours = date.getHours();\n            const minutes = date.getMinutes().toString().padStart(2, '0');\n\n            let convItem = {\n                \"title\": title,\n                \"conversationid\": convo.id,\n                \"time\": hours + ':' + minutes,\n            };\n\n            // Save entry under the date.\n            if (!groupedByDate[dateString]) {\n                groupedByDate[dateString] = [];\n            }\n            groupedByDate[dateString].push(convItem);\n        }\n    });\n\n    // Convert the grouped objects into an array format that Mustache can iterate over.\n    let convert = {\n        groups: Object.keys(groupedByDate).map(key => ({\n            key: key,\n            objects: groupedByDate[key]\n        }))\n    };\n\n    // Render history.\n    const templateData = {\n        \"dates\": convert.groups,\n    };\n    const {html, js} = await Templates.renderForPromise('block_ai_chat/history', templateData);\n    Templates.appendNodeContents('.block_ai_chat_modal .block_ai_chat-output', html, js);\n\n    // Add a listener for the new dialog button.\n    const btnNewDialog = document.getElementById('ai_chat_history_new_dialog');\n    btnNewDialog.addEventListener('mousedown', () => {\n        newDialog();\n    });\n};\n\n/**\n * Remove currrent conversation from history.\n */\nconst removeFromHistory = () => {\n    // Cant remove if new or not yet in history.\n    if (conversation.id !== 0 && allConversations.find(x => x.id === conversation.id) !== undefined) {\n        // Build new allConversations array without deleted one.\n        allConversations = allConversations.filter(obj => obj.id !== conversation.id);\n    }\n};\n\n/**\n * Webservice Save conversation.\n * @param {*} question\n * @param {*} reply\n */\nconst saveConversationLocally = (question, reply) => {\n    // Add to local representation.\n    let message = {'message': question, 'sender': 'user'};\n    conversation.messages.push(message);\n    message = {'message': reply, 'sender': 'ai'};\n    conversation.messages.push(message);\n};\n\n/**\n * Clear output div.\n * @param {*} hideinput\n */\nconst clearMessages = (hideinput = false) => {\n    const output = document.querySelector('.block_ai_chat-output');\n    output.innerHTML = '';\n    // For showing history.\n    let input = document.querySelector('.block_ai_chat-input');\n    if (hideinput) {\n        input.style.display = 'none';\n    } else {\n        input.style.display = 'flex';\n    }\n};\n\n/**\n * Set modal header title.\n * @param {*} setTitle\n */\nconst setModalHeader = (setTitle = '') => {\n    let modalheader = document.querySelector('.block_ai_chat_modal .modal-title div');\n    let title = '';\n    if (modalheader !== null && (conversation.messages.length > 0 || setTitle.length)) {\n        if (!setTitle.length) {\n            if (conversation.messages[0].sender == 'system') {\n                title = conversation.messages[1].message;\n            } else {\n                title = conversation.messages[0].message;\n            }\n        } else {\n            title = setTitle;\n        }\n        modalheader.innerHTML = title;\n    }\n    // Remove onhistorypage, since history page is setting it.\n    let modal = document.querySelector('.block_ai_chat_modal');\n    modal.classList.remove('onhistorypage');\n};\n\n/**\n * Attach event listener.\n * @param {*} textarea\n */\nconst addTextareaListener = (textarea) => {\n    textarea.addEventListener('keydown', (event) => {\n        // Handle submission.\n        textareaOnKeydown(event);\n\n        // Handle autgrow.\n        // Reset the height to auto to get the correct scrollHeight.\n        textarea.style.height = 'auto';\n\n        // Fetch the computed styles.\n        const computedStyles = window.getComputedStyle(textarea);\n        const lineHeight = parseFloat(computedStyles.lineHeight);\n        const paddingTop = parseFloat(computedStyles.paddingTop);\n        const paddingBottom = parseFloat(computedStyles.paddingBottom);\n        const borderTop = parseFloat(computedStyles.borderTopWidth);\n        const borderBottom = parseFloat(computedStyles.borderBottomWidth);\n\n        // Calculate the maximum height for four rows plus padding and borders.\n        const maxHeight = (lineHeight * 4) + paddingTop + paddingBottom + borderTop + borderBottom;\n\n        // Calculate the new height based on the scrollHeight.\n        const newHeight = Math.min(textarea.scrollHeight + borderTop + borderBottom, maxHeight);\n\n        // Set the new height.\n        textarea.style.height = newHeight + 'px';\n    });\n};\n\n/**\n * Action for textarea submission.\n * @param {*} event\n */\nconst textareaOnKeydown = (event) => {\n    if (event.key === 'Enter' && !aiAtWork && !event.shiftKey) {\n        aiAtWork = true;\n        enterQuestion(event.target.value);\n        event.preventDefault();\n        event.target.value = '';\n    }\n};\n\n/**\n * Submit form.\n */\nconst clickSubmitButton = () => {\n    // Var aiAtWork to make it impossible to submit multiple questions at once.\n    if (!aiAtWork) {\n        aiAtWork = true;\n        const textarea = document.getElementById('block_ai_chat-input-id');\n        enterQuestion(textarea.value);\n        textarea.value = '';\n    }\n};\n\n/**\n * Handle error from local_ai_manager.\n * @param {*} requestresult\n * @param {*} question\n * @param {*} contextid\n * @param {*} options\n * @returns {object}\n */\nconst errorHandling = async (requestresult, question, contextid, options) => {\n\n    // If code 409, conversationid is already taken, try get new a one.\n    if (requestresult.code == 409) {\n        while (requestresult.code == 409) {\n            try {\n                let idresult = await externalServices.getNewConversationId(contextid);\n                conversation.id = idresult.id;\n                options.itemid = conversation.id;\n            } catch (error) {\n                displayException(error);\n            }\n            // Retry with new id.\n            requestresult = await manager.askLocalAiManager('chat', question, contextid, options);\n            return requestresult;\n        }\n    }\n\n    // If any other errorcode, alert with errormessage.\n    const errorString = await getString('errorwithcode', 'block_ai_chat', requestresult.code);\n    const result = JSON.parse(requestresult.result);\n    await displayAlert(errorString, result.message);\n\n    // Change answer styling to differentiate from ai.\n    const answerdivs = document.querySelectorAll('.awaitanswer');\n    const answerdiv = answerdivs[answerdivs.length - 1];\n    const messagediv = answerdiv.closest('.message');\n    messagediv.classList.add('text-danger');\n\n    // And write generic error message in chatbot.\n    requestresult.result = await getString('error', 'block_ai_chat');\n    return requestresult;\n};\n\n/**\n * Check historic messages for max length.\n * @param {array} messages\n * @returns {array}\n */\nconst checkMessageHistoryLengthLimit = async (messages) => {\n    const length = messages.length;\n    if (length > maxHistory) {\n        // Cut history.\n        let shortenedMessages = [messages[0], ...messages.slice(-maxHistory)];\n\n        // Show warning once per session.\n        if (!maxHistoryWarnings.has(conversation.id)) {\n            const maxHistoryString = await getString('maxhistory', 'block_ai_chat', maxHistory);\n            const warningErrorString = await getString('maxhistoryreached', 'block_ai_chat', maxHistory);\n            await displayAlert(maxHistoryString, warningErrorString);\n            // Remember warning.\n            maxHistoryWarnings.add(conversation.id);\n        }\n        return shortenedMessages;\n    }\n    // Limit not reached, return messages.\n    return messages;\n};\n\n/**\n * Check if modal should close on outside click.\n * @param {*} event\n */\nconst checkOutsideClick = (event) => {\n    // View openfull acts like a normal modal.\n    if (viewmode != VIEW_OPENFULL) {\n        event.preventDefault();\n    }\n};\n\n/**\n * Set different viewmodes and save in local storage.\n * @param {string} mode\n */\nconst setView = async (mode = '') => {\n    const key = await hash('chatmode' + userid);\n    // Check for saved viewmode.\n    let savedmode = LocalStorage.get(key);\n    if (mode == '') {\n        if (!savedmode) {\n            // Set default.\n            mode = VIEW_CHATWINDOW;\n        } else {\n            mode = savedmode;\n        }\n    }\n    // Save viewmode and set global var.\n    LocalStorage.set(key, mode);\n    viewmode = mode;\n\n    // Set viewmode as bodyclass.\n    const body = document.querySelector('body');\n    body.classList.remove(VIEW_CHATWINDOW, VIEW_OPENFULL, VIEW_DOCKRIGHT);\n    body.classList.add(mode);\n};\n\n/**\n * Is user allowed new queries.\n * @returns {message}\n */\nconst userAllowed = async () => {\n    if (tenantConfig.availability.available === 'disabled') {\n        return tenantConfig.availability.errormessage;\n    }\n    if (chatConfig.available === 'disabled') {\n        return chatConfig.errormessage;\n    }\n    return '';\n};\n\n/**\n * Change to openfull view when screen is small.\n * @param {*} e\n */\nconst handleScreenWidthChange = (e) => {\n    const body = document.querySelector('body');\n    if (e.matches) {\n        // Screen width is less than 576px\n        body.classList.remove(VIEW_CHATWINDOW, VIEW_OPENFULL, VIEW_DOCKRIGHT);\n        body.classList.add(VIEW_OPENFULL);\n    } else {\n        body.classList.remove(VIEW_CHATWINDOW, VIEW_OPENFULL, VIEW_DOCKRIGHT);\n        body.classList.add(viewmode);\n    }\n};\n\n/**\n * Show personas modal.\n */\nconst showPersonasModal = () => {\n    // Add a dynamic form to add a systemprompt/persona to a block instance.\n    // Always create the dynamic form modal, since it is being destroyed.\n    personaForm = new ModalForm({\n        formClass: \"block_ai_chat\\\\form\\\\persona_form\",\n        moduleName: \"block_ai_chat/modal_save_delete_cancel\",\n        args: {\n            contextid: contextid,\n        },\n        modalConfig: {\n            title: strDefinePersona,\n        },\n    });\n\n    // Show modal.\n    personaForm.show();\n\n    // If select[template] is changed, change textarea[prompt].\n    // For this, we want to get the value of the hidden input with name=\"prompts\".\n    // So we wait for the modalForm() to be LOADED to get the modal object.\n    // On the modal object we wait for the bodyRendered event to read the input.\n    personaForm.addEventListener(personaForm.events.LOADED, () => {\n        personaForm.modal.getRoot().on(ModalEvents.bodyRendered, () => {\n            const inputprompts = document.querySelector('input[name=\"prompts\"]');\n            const prompts = JSON.parse(inputprompts.value);\n            const select = document.querySelector('select[name=\"template\"]');\n            const addpersona = document.querySelector('#add_persona');\n            const copypersona = document.querySelector('#copy_persona');\n            personaNewname = document.querySelector('input[name=\"name\"]');\n            personaInputprompt = document.querySelector('textarea[name=\"prompt\"]');\n            personaUserinfo = document.querySelector('textarea[name=\"userinfo\"]');\n            const inputtemplateids = document.querySelector('input[name=\"templateids\"]');\n            const templateids = JSON.parse(inputtemplateids.value);\n            const inputuserinfos = document.querySelector('input[name=\"userinfos\"]');\n            const userinfos = JSON.parse(inputuserinfos.value);\n            personaButtondelete = document.querySelector('[data-custom=\"delete\"]');\n            systemTemplateHiddenInput = document.querySelector('[data-type=\"systemtemplate\"]');\n\n            personaNewname.value = personaNewname.value.trim();\n\n            // Sort personal templates to the end, so we can make two categories in the dropdown.\n            select.options.forEach((option) => {\n                if (!templateids.map(id => parseInt(id)).includes(parseInt(option.value)) && parseInt(option.value) !== 0) {\n                    select.options[select.options.length - 1].after(option);\n                }\n            });\n\n            // Disable delete/name on system templates.\n            manageInputs(false, templateids, select.value);\n\n            // Now we can add a listener to reflect select[template] to textarea[prompt].\n            select.addEventListener('change', (event) => {\n                let selectValue = event.target.value;\n                let selectText = event.target.options[select.selectedIndex].text.trim();\n                // Enable all.\n                manageInputs(true);\n\n                // Reflect prompt, name and userinfos.\n                if (typeof prompts[selectValue] !== 'undefined') {\n                    personaInputprompt.value = prompts[selectValue];\n                    // For personaNewname, get_formdata needs setAttribute,\n                    // but .value is used to repopulate after placeholder is used.\n                    personaNewname.value = selectText;\n                    personaNewname.setAttribute('placeholder', '');\n                    personaNewname.setAttribute('value', selectText);\n                    personaUserinfo.value = userinfos[selectValue];\n                    personaUserinfo.disabled = false;\n                    personaInputprompt.disabled = false;\n                } else {\n                    // Should be selection \"No Persona\"\n                    personaNewname.value = '';\n                    personaNewname.setAttribute('value', '');\n                    personaInputprompt.value = '';\n                    personaInputprompt.disabled = true;\n                    personaUserinfo.value = '';\n                    personaUserinfo.disabled = true;\n                }\n                // Disable delete/name on system templates.\n                manageInputs(false, templateids, selectValue);\n            });\n\n            // Remove newpersona signifier option on click.\n            select.addEventListener('click', () => {\n                let option = document.querySelector('.new-persona-placeholder');\n                if (option) {\n                    select.removeChild(option);\n                }\n            });\n\n            // Add headlines and spacing to the template select element.\n            // But before adding options make a comparison to check for usertemplates.\n            const useroptions = select.options.length > templateids.length;\n            // Add spacing after \"No persona\".\n            const spacer = new Option('', '', false, false);\n            spacer.disabled = true;\n            spacer.classList.add('select-spacer');\n            select.insertBefore(spacer, select.options[1]);\n            // Add systemtemplates heading.\n            const systemtemplates = new Option(strSystemTemplates, '', false, false);\n            systemtemplates.disabled = true;\n            select.insertBefore(systemtemplates, select.options[2]);\n            // // Add usertemplates heading.\n            if (useroptions) {\n                let lastSystemOption;\n                if (templateids.length === 0) {\n                    lastSystemOption = systemtemplates;\n                } else {\n                    // Get last systemtemplate position.\n                    const maxValue = Math.max(...templateids.map(id => parseInt(id)));\n                    lastSystemOption = Array.from(select.options).find(opt => parseInt(opt.value) === maxValue);\n                }\n                // Add heading.\n                const usertemplates = new Option(strUserTemplates, '', false, false);\n                usertemplates.disabled = true;\n                select.insertBefore(usertemplates, lastSystemOption.nextSibling);\n            }\n\n            // Add listener to addPersona icon.\n            addpersona.addEventListener('click', () => {\n                addPersona(false, select);\n            });\n\n            // Add listener to copyPersona icon.\n            copypersona.addEventListener('click', () => {\n                addPersona(true, select);\n            });\n\n            // To use process_dynamic_submission() for deletion, we use a save button but add a delete hidden input.\n            // Make sure it is set 1 on deletion and to 0 on actual saving process.\n            const actionbuttons = document.querySelectorAll('[data-action=\"save\"]');\n            actionbuttons.forEach((button) => {\n                button.addEventListener('click', async (e) => {\n                    const deleteinput = document.querySelector('input[name=\"delete\"]');\n                    if (e.target.dataset.custom == 'delete') {\n                        deleteinput.value = '1';\n                        if (e.target.dataset.confirmed !== \"1\") {\n                            e.stopPropagation();\n                            await confirmModal(getString('delete', 'core'),\n                                getString('areyousuredelete', 'block_ai_chat'),\n                                getString('delete', 'core'),\n                                null,\n                                () => {\n                                    e.target.dataset.confirmed = \"1\";\n                                    e.target.click();\n                                },\n                                null\n                            );\n                        }\n                    } else {\n                        deleteinput.value = '0';\n                        if (select.value == \"\" && isAdmin && e.target.dataset.confirmed !== \"1\") {\n                            e.stopPropagation();\n                            const modal = await SaveCancelModal.create({\n                                title: getString('systemorpersonal_title', 'block_ai_chat'),\n                                body: getString('systemorpersonal_question', 'block_ai_chat'),\n                                buttons: {\n                                    save: getString('systemtemplate', 'block_ai_chat'),\n                                    cancel: getString('personaltemplate', 'block_ai_chat')\n                                },\n                                removeOnClose: true,\n                                show: true\n                            });\n                            modal.getRoot().on(ModalEvents.save,\n                                () => {\n                                    systemTemplateHiddenInput.value = 1;\n                                    e.target.dataset.confirmed = \"1\";\n                                    e.target.click();\n                                }\n                            );\n                            modal.getRoot().on(ModalEvents.cancel,\n                                () => {\n                                    systemTemplateHiddenInput.value = 0;\n                                    e.target.dataset.confirmed = \"1\";\n                                    e.target.click();\n                                }\n                            );\n                        }\n                    }\n                });\n            });\n        });\n    });\n\n    // Enable admintemplate name input on save.\n    personaForm.addEventListener(personaForm.events.SUBMIT_BUTTON_PRESSED, () => {\n        manageInputs(true);\n    });\n\n    // Also enable admintemplate name input on error.\n    personaForm.addEventListener(personaForm.events.SERVER_VALIDATION_ERROR, () => {\n        manageInputs(true);\n    });\n\n    // Reload persona and rewrite info on submission.\n    personaForm.addEventListener(personaForm.events.FORM_SUBMITTED, async () => {\n        let reply = await externalServices.reloadPersona(contextid);\n        personaPrompt = reply.prompt;\n        personaInfo = reply.info;\n        showUserinfo(false);\n    });\n};\n\n/**\n * Show options modal.\n */\nconst showOptionsModal = () => {\n    // Add a dynamic form to add options.\n    // Always create the dynamic form modal, since it is being destroyed.\n    optionsForm = new ModalForm({\n        formClass: \"block_ai_chat\\\\form\\\\options_form\",\n        moduleName: \"core/modal_save_cancel\",\n        args: {\n            contextid: contextid,\n        },\n        modalConfig: {\n            title: getString('options'),\n        },\n    });\n\n    // Show modal.\n    optionsForm.show();\n\n    // Reload options on submission.\n    optionsForm.addEventListener(optionsForm.events.FORM_SUBMITTED, async () => {\n        let reply = await externalServices.getConversationcontextLimit(contextid);\n        maxHistory = reply.limit;\n    });\n};\n\n/**\n * Click on add new persona, make input writable and reset if no copy.\n * @param {bool} copy\n * @param {HTMLElement} select\n */\nconst addPersona = (copy, select) => {\n    // Enable inputs and set a placeholder.\n    personaNewname.disabled = false;\n    personaNewname.placeholder = strNewPersona;\n    personaNewname.value = '';\n    personaInputprompt.disabled = false;\n    personaUserinfo.disabled = false;\n    if (!copy) {\n        personaInputprompt.value = '';\n        personaUserinfo.value = '';\n    }\n    // Add option to signify new persona.\n    let option = document.querySelector('.new-persona-placeholder');\n    if (!option) {\n        let signifierOption = new Option(strNewPersona, '', true, true);\n        signifierOption.classList.add('new-persona-placeholder');\n        select.add(signifierOption);\n    }\n};\n\nconst manageInputs = (switchon, templateids = [], selectValue = 42) => {\n    // Switch all inputs on.\n    if ((switchon || isAdmin) && selectValue != 0) {\n        // Enable everything except for \"No persona\".\n        personaNewname.disabled = false;\n        personaButtondelete.disabled = false;\n        personaInputprompt.disabled = false;\n        personaUserinfo.disabled = false;\n        return;\n    }\n    // Abort on reload if validation failed.\n    if (document.querySelector('.is-invalid') !== null) {\n        return;\n    }\n    // Switch input between admin and user templates.\n    if (templateids.includes(selectValue) || selectValue == 0) {\n        personaNewname.disabled = true;\n        personaButtondelete.disabled = true;\n        personaInputprompt.disabled = true;\n        personaUserinfo.disabled = true;\n    } else {\n        personaNewname.disabled = false;\n        personaButtondelete.disabled = false;\n        personaInputprompt.disabled = false;\n        personaUserinfo.disabled = false;\n    }\n};\n\nconst showUserinfo = async (first) => {\n    // If persona is updated, delete current infobox.\n    if (!first) {\n        const toDelete = document.querySelector('.local_ai_manager-infobox.alert.alert-info');\n        if (toDelete) {\n            toDelete.remove();\n        }\n    }\n\n    if (personaInfo.trim() != '') {\n        const targetElement = document.querySelector('.block_ai_chat_modal_body .infobox');\n        const templateContext = {\n            'persona': personaInfo,\n            'personainfourl': personaLink,\n        };\n        const {html, js} = await Templates.renderForPromise('block_ai_chat/persona_infobox', templateContext);\n        Templates.appendNodeContents(targetElement, html, js);\n    }\n};\n"],"names":["VIEW_CHATWINDOW","VIEW_OPENFULL","VIEW_DOCKRIGHT","strHistory","strNewDialog","strToday","strYesterday","strDefinePersona","strNewPersona","strUserTemplates","strSystemTemplates","badge","viewmode","modal","personaForm","personaPrompt","personaInfo","personaLink","personaNewname","personaButtondelete","personaUserinfo","personaInputprompt","systemTemplateHiddenInput","showPersona","optionsForm","showOptions","isAdmin","modalopen","conversation","id","messages","allConversations","userid","contextid","firstLoad","aiAtWork","maxHistory","maxHistoryWarnings","Set","tenantConfig","chatConfig","agentMode","DialogModal","Modal","configure","modalConfig","show","removeOnClose","isVerticallyCentered","hide","document","querySelector","classList","remove","async","params","new","history","persona","newpersona","usertemplates","systemtemplates","personaprompt","personainfo","showpersona","showoptions","personalink","isadmin","aiConfig","purposes","agentString","create","templateContext","identifier","checked","text","title","getRoot","on","e","target","add","ModalEvents","outsideClick","event","checkOutsideClick","setView","getElementById","addEventListener","console","log","body","setInterval","style","overflow","textarea","addTextareaListener","clickSubmitButton","getConversations","showConversation","reply","externalServices","getConversationcontextLimit","limit","newDialog","deleteCurrentDialog","showHistory","btnDefinePersona","showPersonasModal","btnOptions","showOptionsModal","warningBoxSelector","showUserinfo","message","userAllowed","notice","aiUtilsButton","uniqid","Math","random","toString","slice","TinyAiUtils","init","TinyAiConstants","modalModes","standalone","selectionObject","window","getSelection","rangeCount","range","getRangeAt","container","createElement","appendChild","cloneContents","images","querySelectorAll","length","src","image","fetchResult","fetch","data","blob","getDatamanager","setSelectionImg","setSelection","editorUtils","TinyAiEditorUtils","setEditorUtils","displayDialogue","helper","focustextarea","showModal","matchMedia","handleScreenWidthChange","innerWidth","getAllConversations","error","find","x","at","clearMessages","setModalHeader","showMessages","enterQuestion","question","showMessage","sender","unshift","convHistory","checkMessageHistoryLengthLimit","trim","shift","options","idresult","getNewConversationId","timecreated","floor","Date","now","forcenewitemid","requestresult","itemid","agentoptions","formelements","DomExtractor","extractDomElements","pagedock","extractPageDock","pageid","suggestionContext","conversationcontext","manager","askLocalAiManager","agentAnswer","result","JSON","parse","chatOutputIntroObject","chatoutput","filter","object","type","chatOutputOutroObject","intro","suggestions","outro","forEach","formElement","htmlElement","tagName","new_value","value","extractedDomElement","element","push","fieldname","label","explanation","elementId","suggestionvalue","code","errorHandling","showReply","renderMathjax","saveConversationLocally","innerHTML","agentSuggestionsContext","fields","field","context","html","js","Templates","renderForPromise","replaceNodeContents","awaitdivs","scrollHeight","clientHeight","item","answer","templateData","appendNodeContents","attachCopyListenerLast","scrollToBottom","deleted","undefined","then","deleteConversation","removeFromHistory","catch","groupedByDate","convo","date","today","getFullYear","getMonth","getDate","yesterday","twoWeeksAgo","setDate","weekday","day","month","monthOptions","year","dateString","toLocaleDateString","hours","getHours","minutes","getMinutes","padStart","convItem","groups","Object","keys","map","key","objects","obj","hideinput","output","input","display","setTitle","modalheader","textareaOnKeydown","height","computedStyles","getComputedStyle","lineHeight","parseFloat","paddingTop","paddingBottom","borderTop","borderTopWidth","borderBottom","borderBottomWidth","maxHeight","newHeight","min","shiftKey","preventDefault","errorString","answerdivs","closest","shortenedMessages","has","maxHistoryString","warningErrorString","mode","savedmode","LocalStorage","get","set","availability","available","errormessage","matches","ModalForm","formClass","moduleName","args","events","LOADED","bodyRendered","inputprompts","prompts","select","addpersona","copypersona","inputtemplateids","templateids","inputuserinfos","userinfos","option","parseInt","includes","after","manageInputs","selectValue","selectText","selectedIndex","setAttribute","disabled","removeChild","useroptions","spacer","Option","insertBefore","lastSystemOption","maxValue","max","Array","from","opt","nextSibling","addPersona","button","deleteinput","dataset","custom","confirmed","stopPropagation","click","SaveCancelModal","buttons","save","cancel","SUBMIT_BUTTON_PRESSED","SERVER_VALIDATION_ERROR","FORM_SUBMITTED","reloadPersona","prompt","info","copy","placeholder","signifierOption","switchon","first","toDelete","targetElement"],"mappings":"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"}