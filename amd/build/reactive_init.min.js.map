{"version":3,"file":"reactive_init.min.js","sources":["../src/reactive_init.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n\nimport {Reactive} from 'core/reactive';\nimport {eventTypes, notifyBlockAiChatStateUpdated} from 'block_ai_chat/events';\nimport MainComponent from 'block_ai_chat/components/main';\nimport Mutations from 'block_ai_chat/mutations';\nimport * as Ajax from 'core/ajax';\nimport {exception as displayException, alert as alertModal} from 'core/notification';\nimport Log from 'core/log';\nimport {RENDER_MODE} from 'block_ai_chat/constants';\n\n\n/**\n * Main module for the reactive frontend of the block_ai_chat.\n *\n * @module     block_ai_chat/reactive_init\n * @copyright  2025 ISB Bayern\n * @author     Philipp Memmel\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\n/**\n * Initialize the main component.\n *\n * Multiple embedded instances (modal = null) are supported, but only one modal instance (modal object\n * needs to be passed).\n *\n * @param {number} contextid The context id\n * @param {string} mainElementSelector Selector for the main element. Needs to be unique on the page.\n * @param {object|null} modal The modal instance or null for embedded mode.\n * @returns {Promise<MainComponent|undefined>} The initialized main component or undefined on error.\n */\nexport const init = async(contextid, mainElementSelector, modal = null) => {\n    // Just one modal per page is allowed/supported.\n    // Multiple embedded instances per page however are allowed/supported.\n\n    const mainElement = document.querySelector(mainElementSelector);\n    if (!mainElement) {\n        const errormessage = 'No main element found for selector ' + mainElementSelector;\n        await alertModal(errormessage);\n        return;\n    }\n    if (modal === null && (!mainElement.dataset.hasOwnProperty('id') || mainElement.dataset.id.length === 0)) {\n        const errormessage = 'No data id attribute found on main element for selector ' + mainElementSelector;\n        await alertModal(errormessage);\n        return;\n    }\n\n    // Fetch and prepare the initial state.\n    let state = null;\n    // This external function is a bit special, so we do not use callExternalFunction from 'block_ai_chat/utils' here.\n    try {\n        state = await Ajax.call([{\n            methodname: 'block_ai_chat_get_initial_state',\n            args: {\n                contextid,\n            }\n        }])[0];\n    } catch (error) {\n        Log.error('Error while retrieving initial state', error);\n        await displayException(error);\n        return;\n    }\n\n    state.static.renderMode = modal === null ? RENDER_MODE.EMBEDDED : RENDER_MODE.MODAL;\n\n    let reactiveChatName;\n    if (state.static.renderMode === RENDER_MODE.MODAL) {\n        // Only one modal instance per page is allowed, so no need to make the name more unique than that.\n        reactiveChatName = 'block_ai_chat_reactive_chat_modal';\n    } else {\n        // Use the data id attribute to make the name unique for multiple embedded instances.\n        // It's basically just for debugging purposes so the reactive instance can be identified\n        // as reactive instance of a specific rendering process.\n        reactiveChatName = 'block_ai_chat_reactive_chat_embedded_' + mainElement.dataset.id;\n    }\n\n    // Create the reactive instance.\n    const reactiveChat = new Reactive({\n        name: reactiveChatName,\n        eventName: eventTypes.blockAiChatStateUpdated,\n        eventDispatch: notifyBlockAiChatStateUpdated,\n        mutations: new Mutations(),\n        state,\n    });\n\n    // Spin up the main component for the reactive UI.\n    // All further components will be created by the main component itself.\n    new MainComponent({\n        element: mainElement,\n        reactive: reactiveChat,\n        modal: modal\n    });\n};"],"names":["async","contextid","mainElementSelector","modal","mainElement","document","querySelector","errormessage","dataset","hasOwnProperty","id","length","reactiveChatName","state","Ajax","call","methodname","args","error","static","renderMode","RENDER_MODE","EMBEDDED","MODAL","reactiveChat","Reactive","name","eventName","eventTypes","blockAiChatStateUpdated","eventDispatch","notifyBlockAiChatStateUpdated","mutations","Mutations","MainComponent","element","reactive"],"mappings":";;;;;;;;42BA8CoBA,eAAMC,UAAWC,yBAAqBC,6DAAQ,WAIxDC,YAAcC,SAASC,cAAcJ,yBACtCE,YAAa,OACRG,aAAe,sCAAwCL,sCACvD,uBAAWK,iBAGP,OAAVJ,SAAoBC,YAAYI,QAAQC,eAAe,OAA2C,IAAlCL,YAAYI,QAAQE,GAAGC,QAAe,OAChGJ,aAAe,2DAA6DL,sCAC5E,uBAAWK,kBAsBjBK,iBAjBAC,MAAQ,SAGRA,YAAcC,KAAKC,KAAK,CAAC,CACrBC,WAAY,kCACZC,KAAM,CACFhB,UAAAA,cAEJ,GACN,MAAOiB,2BACDA,MAAM,uCAAwCA,kBAC5C,2BAAiBA,OAI3BL,MAAMM,OAAOC,WAAuB,OAAVjB,MAAiBkB,uBAAYC,SAAWD,uBAAYE,MAK1EX,iBAFAC,MAAMM,OAAOC,aAAeC,uBAAYE,MAErB,oCAKA,wCAA0CnB,YAAYI,QAAQE,SAI/Ec,aAAe,IAAIC,mBAAS,CAC9BC,KAAMd,iBACNe,UAAWC,mBAAWC,wBACtBC,cAAeC,sCACfC,UAAW,IAAIC,mBACfpB,MAAAA,YAKAqB,cAAc,CACdC,QAAS/B,YACTgC,SAAUZ,aACVrB,MAAOA"}