define("block_ai_interface/dialog",["exports","block_ai_interface/dialog_modal","block_ai_interface/webservices","core/templates","core/notification","local_ai_manager/make_request"],(function(_exports,_dialog_modal,externalServices,_templates,_notification,_make_request){function _getRequireWildcardCache(nodeInterop){if("function"!=typeof WeakMap)return null;var cacheBabelInterop=new WeakMap,cacheNodeInterop=new WeakMap;return(_getRequireWildcardCache=function(nodeInterop){return nodeInterop?cacheNodeInterop:cacheBabelInterop})(nodeInterop)}function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.init=void 0,_dialog_modal=_interopRequireDefault(_dialog_modal),externalServices=function(obj,nodeInterop){if(!nodeInterop&&obj&&obj.__esModule)return obj;if(null===obj||"object"!=typeof obj&&"function"!=typeof obj)return{default:obj};var cache=_getRequireWildcardCache(nodeInterop);if(cache&&cache.has(obj))return cache.get(obj);var newObj={},hasPropertyDescriptor=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var key in obj)if("default"!==key&&Object.prototype.hasOwnProperty.call(obj,key)){var desc=hasPropertyDescriptor?Object.getOwnPropertyDescriptor(obj,key):null;desc&&(desc.get||desc.set)?Object.defineProperty(newObj,key,desc):newObj[key]=obj[key]}newObj.default=obj,cache&&cache.set(obj,newObj);return newObj}(externalServices),_templates=_interopRequireDefault(_templates);let modal={},modaltitle="",conversation={id:0,messages:[]},allConversations=[],userid=0,contextid=0,firstLoad=!0;_exports.init=async params=>{userid=params.userid,contextid=params.contextid,modaltitle=params.title,modal=await _dialog_modal.default.create({templateContext:{title:modaltitle}}),modal.getRoot().on("modal:shown",(function(e){e.target.classList.add("ai_interface_modal"),e.target.scrollTo(0,e.target.scrollHeight)})),document.getElementById("ai_interface_button").addEventListener("mousedown",(function(){!async function(){modal.show();const textarea=document.getElementById("block_ai_interface-input-id");if(addTextareaListener(textarea),firstLoad){showConversation(),addToHistory(allConversations);document.getElementById("block_ai_interface_new_dialog").addEventListener("mousedown",(()=>{newDialog()})),firstLoad=!1}setTimeout((function(){focustextarea()}),300)}()})),getConversations(),console.log(contextid)};const showReply=text=>{document.querySelector(".ai_interface_modal .awaitanswer div").replaceWith(text)},newDialog=()=>{console.log("newDialog called"),conversation={id:0,messages:[]},clearMessages(),setModalHeader(!0)},askLocalAiManager=async function(purpose,prompt){let options=arguments.length>2&&void 0!==arguments[2]?arguments[2]:[],result=await(0,_make_request.makeRequest)(purpose,prompt,JSON.stringify(options));return console.log(result),result},showMessage=function(text){let sender=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"",answer=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];"ai"===sender&&(sender="");const templateData={sender:sender,content:text,answer:answer};_templates.default.renderForPromise("block_ai_interface/message",templateData).then((_ref=>{let{html:html,js:js}=_ref;return _templates.default.appendNodeContents(".block_ai_interface-output",html,js),!0})).catch((ex=>(0,_notification.exception)(ex)))},showMessages=()=>{console.log("showMessages called"),conversation.messages.forEach((val=>{showMessage(val.message,val.sender)}));const modaldiv=document.querySelector(".ai_interface_modal");null!==modaldiv&&setTimeout((()=>{modaldiv.scrollTo(0,modaldiv.scrollHeight)}),5)},clearMessages=()=>{console.log("clearMessages called");document.querySelector(".block_ai_interface-output").innerHTML=""},getConversations=async()=>{allConversations=await externalServices.getAllConversations(userid,contextid)},addToHistory=convos=>{convos.forEach((convo=>{let title=convo.messages[0].message;convo.messages[0].message.length>50&&(title=convo.messages[0].message.substring(0,50),title+=" ...");const templateData={title:title,conversationid:convo.id};_templates.default.renderForPromise("block_ai_interface/dropdownmenuitem",templateData).then((_ref2=>{let{html:html,js:js}=_ref2;return _templates.default.appendNodeContents(".block_ai_interface_action_menu .dropdown-menu",html,js),!0})).catch((ex=>(0,_notification.exception)(ex)))}))},showConversation=function(){let id=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;0!==id?conversation=allConversations.find((x=>x.id===id)):void 0!==allConversations[0]&&(conversation=allConversations.at(-1)),clearMessages(),showMessages(),setModalHeader()};document.showConversation=showConversation;const saveConversation=async(question,reply)=>{await externalServices.saveInteraction(question,reply,conversation.id,userid,contextid)},setModalHeader=function(){let empty=arguments.length>0&&void 0!==arguments[0]&&arguments[0],modalheader=document.querySelector(".ai_interface_modal .modal-title div");if(null!==modalheader){let title="";empty||(title=" - "+conversation.messages[0].message,conversation.messages[0].message.length>50&&(title=" - "+conversation.messages[0].message.substring(0,50),title+=" ...")),modalheader.innerHTML=modaltitle+title}},focustextarea=()=>{let elapsed=0;const checkInterval=setInterval((()=>{const textarea=document.getElementById("block_ai_interface-input-id");if(textarea){clearInterval(checkInterval);document.getElementsByTagName("input")[0].focus(),textarea.focus()}elapsed+=25,elapsed>=2e3&&clearInterval(checkInterval)}),25)},addTextareaListener=textarea=>{textarea.addEventListener("keydown",textareaOnKeydown)},textareaOnKeydown=event=>{"Enter"===event.key&&((question=>{const textarea=document.getElementById("block_ai_interface-input-id");textarea.removeEventListener("keydown",textareaOnKeydown),showMessage(question,"self",!1),askLocalAiManager("chat",question,{component:"block_ai_interface",contextid:contextid,messages:conversation}).then((requestresult=>{"error"!=requestresult.string&&(showReply(requestresult.result),saveConversation(question,requestresult.result),addTextareaListener(textarea))})).catch((error=>(0,_notification.exception)(error)))})(event.target.value),event.preventDefault(),event.target.value="")}}));

//# sourceMappingURL=dialog.min.js.map