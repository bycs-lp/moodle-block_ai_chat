define("block_ai_interface/dialog",["exports","block_ai_interface/dialog_modal","block_ai_interface/webservices","core/templates","core/notification","block_ai_interface/helper","block_ai_interface/ai_manager","core/str"],(function(_exports,_dialog_modal,externalServices,_templates,_notification,helper,manager,_str){function _getRequireWildcardCache(nodeInterop){if("function"!=typeof WeakMap)return null;var cacheBabelInterop=new WeakMap,cacheNodeInterop=new WeakMap;return(_getRequireWildcardCache=function(nodeInterop){return nodeInterop?cacheNodeInterop:cacheBabelInterop})(nodeInterop)}function _interopRequireWildcard(obj,nodeInterop){if(!nodeInterop&&obj&&obj.__esModule)return obj;if(null===obj||"object"!=typeof obj&&"function"!=typeof obj)return{default:obj};var cache=_getRequireWildcardCache(nodeInterop);if(cache&&cache.has(obj))return cache.get(obj);var newObj={},hasPropertyDescriptor=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var key in obj)if("default"!==key&&Object.prototype.hasOwnProperty.call(obj,key)){var desc=hasPropertyDescriptor?Object.getOwnPropertyDescriptor(obj,key):null;desc&&(desc.get||desc.set)?Object.defineProperty(newObj,key,desc):newObj[key]=obj[key]}return newObj.default=obj,cache&&cache.set(obj,newObj),newObj}function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.init=void 0,_dialog_modal=_interopRequireDefault(_dialog_modal),externalServices=_interopRequireWildcard(externalServices),_templates=_interopRequireDefault(_templates),helper=_interopRequireWildcard(helper),manager=_interopRequireWildcard(manager);let modal={},modaltitle="",conversation={id:0,messages:[]},allConversations=[],userid=0,contextid=0,firstLoad=!0,aiAtWork=!1,maxHistory=5,maxHistoryWarnings=new Set;_exports.init=async params=>{userid=params.userid,contextid=params.contextid,modaltitle=params.title,modal=await _dialog_modal.default.create({templateContext:{title:modaltitle}}),modal.getRoot().on("modal:shown",(function(e){e.target.classList.add("ai_interface_modal")})),await getConversations();let conversationcontextLimit=await externalServices.getConversationcontextLimit(contextid);maxHistory=conversationcontextLimit.limit,document.getElementById("ai_interface_button").addEventListener("mousedown",(function(){!async function(){await modal.show();const textarea=document.getElementById("block_ai_interface-input-id");addTextareaListener(textarea);if(document.getElementById("block_ai_interface-submit-id").addEventListener("click",(event=>{clickSubmitButton(event)})),firstLoad){showConversation(),addToHistory(allConversations);document.getElementById("block_ai_interface_new_dialog").addEventListener("mousedown",(()=>{newDialog()}));document.getElementById("block_ai_interface_delete_dialog").addEventListener("click",(()=>{deleteCurrentDialog()})),firstLoad=!1}helper.focustextarea()}()}))};const getConversations=async()=>{console.log("allConversations called");try{allConversations=await externalServices.getAllConversations(userid,contextid)}catch(error){(0,_notification.exception)(error)}},showConversation=function(){let id=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;console.log("showConversation called"),aiAtWork||(0!==id?conversation=allConversations.find((x=>x.id===id)):void 0!==allConversations[0]?conversation=allConversations.at(0):0===allConversations.length&&newDialog(!0),clearMessages(),setModalHeader(),showMessages())};document.showConversation=showConversation;const enterQuestion=async question=>{if(""==question)return void(aiAtWork=!1);showMessage(question,"self",!1),0===conversation.messages.length&&conversation.messages.push({message:"Answer in german",sender:"system"});const convHistory=checkMessageHistoryLengthLimit(),options={component:"block_ai_interface",contextid:contextid,conversationcontext:convHistory};if(0===conversation.id){try{let idresult=await externalServices.getNewConversationId(contextid);conversation.id=idresult.id}catch(error){(0,_notification.exception)(error)}options.forcenewitemid=!0}options.itemid=conversation.id;let requestresult=await manager.askLocalAiManager("chat",question,options);200!=requestresult.code&&(requestresult=await errorHandling(requestresult,question,options)),showReply(requestresult.result),aiAtWork=!1;let copy=document.querySelector(".ai_interface_modal .awaitanswer .copy");copy.addEventListener("mousedown",(()=>{helper.copyToClipboard(copy)})),saveConversationLocally(question,requestresult.result)},showReply=text=>{document.querySelector(".ai_interface_modal .awaitanswer .text div").replaceWith(text)},showMessages=()=>{console.log("showMessages called"),conversation.messages.forEach((val=>{showMessage(val.message,val.sender)}))},showMessage=async function(text){let sender=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"",answer=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];if("system"===sender)return;"ai"===sender&&(sender="");const templateData={sender:sender,content:text,answer:answer},{html:html,js:js}=await _templates.default.renderForPromise("block_ai_interface/message",templateData);_templates.default.appendNodeContents(".block_ai_interface-output",html,js),""===sender&&helper.attachCopyListenerLast(),helper.scrollToBottom()},newDialog=function(){let deleted=arguments.length>0&&void 0!==arguments[0]&&arguments[0];console.log("newDialog called"),void 0!==allConversations.find((x=>x.id===conversation.id))||deleted||(addToHistory([conversation]),allConversations.push(conversation)),conversation={id:0,messages:[]},clearMessages(),setModalHeader(!0)},deleteCurrentDialog=async()=>{if(console.log("deleteCurrentDialog called"),0!==conversation.id)try{await externalServices.deleteConversation(contextid,userid,conversation.id)&&(removeFromHistory(),showConversation())}catch(error){(0,_notification.exception)(error)}},addToHistory=convos=>{if(convos.forEach((async convo=>{if(void 0!==convo.messages[1]){let title=convo.messages[1].message;convo.messages[1].message.length>50&&(title=convo.messages[1].message.substring(0,50),title+=" ...");const templateData={title:title,conversationid:convo.id},{html:html,js:js}=await _templates.default.renderForPromise("block_ai_interface/dropdownmenuitem",templateData);if(_templates.default.appendNodeContents(".block_ai_interface_action_menu .dropdown-menu",html,js),1===convos.length&&allConversations.length>1){console.log("move item to top called");const dropdown=document.querySelector(".block_ai_interface_action_menu .dropdown-menu"),lastItem=dropdown.lastElementChild,thirdChild=dropdown.children[2];dropdown.removeChild(lastItem),dropdown.insertBefore(lastItem,thirdChild)}}})),convos.length>9){document.querySelector(".block_ai_interface_action_menu .dropdown-menu").classList.add("addscroll")}},removeFromHistory=()=>{if(0!==conversation.id&&void 0!==allConversations.find((x=>x.id===conversation.id))){document.querySelector('.block_ai_interface_action_menu [data-id="'+conversation.id+'"]').remove(),allConversations=allConversations.filter((obj=>obj.id!==conversation.id))}},saveConversationLocally=(question,reply)=>{let message={message:question,sender:"user"};conversation.messages.push(message),message={message:reply,sender:"ai"},conversation.messages.push(message)},clearMessages=()=>{console.log("clearMessages called");document.querySelector(".block_ai_interface-output").innerHTML=""},setModalHeader=function(){let empty=arguments.length>0&&void 0!==arguments[0]&&arguments[0],modalheader=document.querySelector(".ai_interface_modal .modal-title div"),title="";null!==modalheader&&(conversation.messages.length>0||empty)&&(empty||(title=" - "+conversation.messages[1].message,conversation.messages[1].message.length>50&&(title=" - "+conversation.messages[1].message.substring(0,50),title+=" ...")),modalheader.textContent=modaltitle+title)},addTextareaListener=textarea=>{textarea.addEventListener("keydown",textareaOnKeydown)},textareaOnKeydown=event=>{"Enter"!==event.key||aiAtWork||event.shiftKey||(aiAtWork=!0,enterQuestion(event.target.value),event.preventDefault(),event.target.value="")},clickSubmitButton=()=>{if(!aiAtWork){aiAtWork=!0;const textarea=document.getElementById("block_ai_interface-input-id");enterQuestion(textarea.value),textarea.value=""}},errorHandling=async(requestresult,question,options)=>{if(409==requestresult.code)for(;409==requestresult.code;){try{let idresult=await externalServices.getNewConversationId(contextid);conversation.id=idresult.id,options.itemid=conversation.id}catch(error){(0,_notification.exception)(error)}return requestresult=await manager.askLocalAiManager("chat",question,options)}const errorString=await(0,_str.getString)("errorwithcode","block_ai_interface",requestresult.code);await(0,_notification.alert)(errorString,requestresult.result);const answerdivs=document.querySelectorAll(".awaitanswer"),messagediv=answerdivs[answerdivs.length-1].closest(".message");messagediv.classList.add("text-danger");return messagediv.querySelector(".identity").textContent="System",requestresult.result=await(0,_str.getString)("error","block_ai_interface"),requestresult},checkMessageHistoryLengthLimit=async()=>{const length=conversation.messages.length;if(console.log("checkHistoryLengthLimit called"),console.log(conversation.messages),length>maxHistory){let tmpMessages=conversation.messages,rebuildMessages=[conversation.messages[0],...tmpMessages.slice(-maxHistory)];if(console.log(rebuildMessages),!maxHistoryWarnings.has(conversation.id)){const maxHistoryString=await(0,_str.getString)("maxhistory","block_ai_interface",maxHistory),warningErrorString=await(0,_str.getString)("maxhistoryreached","block_ai_interface",maxHistory);await(0,_notification.alert)(maxHistoryString,warningErrorString),maxHistoryWarnings.add(conversation.id)}return rebuildMessages}return conversation.messages}}));

//# sourceMappingURL=dialog.min.js.map