define("block_ai_interface/dialog",["exports","block_ai_interface/dialog_modal","block_ai_interface/webservices","core/templates","core/notification","local_ai_manager/make_request","./webservices"],(function(_exports,_dialog_modal,externalServices,_templates,_notification,_make_request,_webservices2){function _getRequireWildcardCache(nodeInterop){if("function"!=typeof WeakMap)return null;var cacheBabelInterop=new WeakMap,cacheNodeInterop=new WeakMap;return(_getRequireWildcardCache=function(nodeInterop){return nodeInterop?cacheNodeInterop:cacheBabelInterop})(nodeInterop)}function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.init=void 0,_dialog_modal=_interopRequireDefault(_dialog_modal),externalServices=function(obj,nodeInterop){if(!nodeInterop&&obj&&obj.__esModule)return obj;if(null===obj||"object"!=typeof obj&&"function"!=typeof obj)return{default:obj};var cache=_getRequireWildcardCache(nodeInterop);if(cache&&cache.has(obj))return cache.get(obj);var newObj={},hasPropertyDescriptor=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var key in obj)if("default"!==key&&Object.prototype.hasOwnProperty.call(obj,key)){var desc=hasPropertyDescriptor?Object.getOwnPropertyDescriptor(obj,key):null;desc&&(desc.get||desc.set)?Object.defineProperty(newObj,key,desc):newObj[key]=obj[key]}newObj.default=obj,cache&&cache.set(obj,newObj);return newObj}(externalServices),_templates=_interopRequireDefault(_templates);let modal={},modaltitle="",conversation={id:0,messages:[]},allConversations=[],userid=0,contextid=0,firstLoad=!0;_exports.init=async params=>{userid=params.userid,contextid=params.contextid,modaltitle=params.title,modal=await _dialog_modal.default.create({templateContext:{title:modaltitle}}),modal.getRoot().on("modal:shown",(function(e){e.target.classList.add("ai_interface_modal"),e.target.scrollTo(0,e.target.scrollHeight)})),await getConversations(),document.getElementById("ai_interface_button").addEventListener("mousedown",(function(){!async function(){await modal.show();const textarea=document.getElementById("block_ai_interface-input-id");if(addTextareaListener(textarea),firstLoad){showConversation(),addToHistory(allConversations);document.getElementById("block_ai_interface_new_dialog").addEventListener("mousedown",(()=>{newDialog()}));document.getElementById("block_ai_interface_new_dialog").addEventListener("mousedown",(()=>{newDialog()})),firstLoad=!1}focustextarea()}()}))};const showReply=text=>{document.querySelector(".ai_interface_modal .awaitanswer .text div").replaceWith(text)},newDialog=()=>{console.log("newDialog called"),void 0===allConversations.find((x=>x.id===conversation.id))&&(addToHistory([conversation]),allConversations.push(conversation)),conversation={id:0,messages:[]},clearMessages(),setModalHeader(!0)},askLocalAiManager=async function(purpose,prompt){let result,options=arguments.length>2&&void 0!==arguments[2]?arguments[2]:[];try{result=await(0,_make_request.makeRequest)(purpose,prompt,JSON.stringify(options))}catch(error){(0,_notification.exception)(error)}return result},showMessages=()=>{console.log("showMessages called"),conversation.messages.forEach((val=>{showMessage(val.message,val.sender)}))},showMessage=async function(text){let sender=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"",answer=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];if("system"===sender)return;"ai"===sender&&(sender="");const templateData={sender:sender,content:text,answer:answer},{html:html,js:js}=await _templates.default.renderForPromise("block_ai_interface/message",templateData);_templates.default.appendNodeContents(".block_ai_interface-output",html,js),scrollToBottom()},clearMessages=()=>{console.log("clearMessages called");document.querySelector(".block_ai_interface-output").innerHTML=""},getConversations=async()=>{console.log("allConversations called");try{allConversations=await externalServices.getAllConversations(userid,contextid)}catch(error){(0,_notification.exception)(error)}},addToHistory=convos=>{if(convos.forEach((async convo=>{let title=convo.messages[1].message;convo.messages[1].message.length>50&&(title=convo.messages[1].message.substring(0,50),title+=" ...");const templateData={title:title,conversationid:convo.id},{html:html,js:js}=await _templates.default.renderForPromise("block_ai_interface/dropdownmenuitem",templateData);if(_templates.default.appendNodeContents(".block_ai_interface_action_menu .dropdown-menu",html,js),1===convos.length){console.log("move item to top called");const dropdown=document.querySelector(".block_ai_interface_action_menu .dropdown-menu"),lastItem=dropdown.lastElementChild,thirdChild=dropdown.children[2];dropdown.removeChild(lastItem),dropdown.insertBefore(lastItem,thirdChild)}})),convos.length>9){document.querySelector(".block_ai_interface_action_menu .dropdown-menu").classList.add("addscroll")}},showConversation=function(){let id=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;console.log("showConversation called"),0!==id?conversation=allConversations.find((x=>x.id===id)):void 0!==allConversations[0]&&(console.log("last item allconv"),conversation=allConversations.at(0)),clearMessages(),showMessages(),setModalHeader(),attachCopyListener()};document.showConversation=showConversation;const saveConversationLocally=(question,reply)=>{let message={message:question,sender:"user"};conversation.messages.push(message),message={message:reply,sender:"ai"},conversation.messages.push(message)},setModalHeader=function(){let empty=arguments.length>0&&void 0!==arguments[0]&&arguments[0],modalheader=document.querySelector(".ai_interface_modal .modal-title div");if(null!==modalheader&&(conversation.messages.length>0||empty)){let title="";empty||(title=" - "+conversation.messages[1].message,conversation.messages[1].message.length>50&&(title=" - "+conversation.messages[1].message.substring(0,50),title+=" ...")),modalheader.innerHTML=modaltitle+title}},focustextarea=()=>{document.getElementsByTagName("input")[0].focus();document.getElementById("block_ai_interface-input-id").focus()},scrollToBottom=()=>{console.log("scroll to bottom called");const modalContent=document.querySelector(".ai_interface_modal .modal-body");modalContent.scrollTop=modalContent.scrollHeight},addTextareaListener=textarea=>{textarea.addEventListener("keydown",textareaOnKeydown)},textareaOnKeydown=event=>{"Enter"===event.key&&((async question=>{const textarea=document.getElementById("block_ai_interface-input-id");textarea.removeEventListener("keydown",textareaOnKeydown),showMessage(question,"self",!1),0===conversation.messages.length&&conversation.messages.push({message:"Answer in german",sender:"system"});const options={component:"block_ai_interface",contextid:contextid,conversationcontext:conversation.messages};if(0===conversation.id){try{let idresult=await externalServices.getNewConversationId(contextid);conversation.id=idresult.id}catch(error){(0,_notification.exception)(error)}options.forcenewitemid=!0}options.itemid=conversation.id;let requestresult=await askLocalAiManager("chat",question,options);for(;409==requestresult.code;){try{let idresult=await externalServices.getNewConversationId(contextid);conversation.id=idresult.id,options.itemid=conversation.id}catch(error){(0,_notification.exception)(error)}requestresult=await askLocalAiManager("chat",question,options)}if(200!=requestresult.code)return void errorHandling();showReply(requestresult.result);let copy=document.querySelector(".ai_interface_modal .awaitanswer .copy");copyToClipboard(copy),saveConversationLocally(question,requestresult.result),addTextareaListener(textarea)})(event.target.value),event.preventDefault(),event.target.value="")},attachCopyListener=()=>{document.querySelectorAll(".ai_interface_modal .copy").forEach((element=>{element.addEventListener("mousedown",(function(){copyToClipboard(element)}))}))},copyToClipboard=element=>{const textElement=element.nextElementSibling,textToCopy=textElement.innerText||textElement.textContent;navigator.clipboard.writeText(textToCopy)},errorHandling=code=>{}}));

//# sourceMappingURL=dialog.min.js.map