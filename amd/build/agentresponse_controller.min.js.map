{"version":3,"file":"agentresponse_controller.min.js","sources":["../src/agentresponse_controller.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Module providing functions to extract information from the form.\n *\n * @module     block_ai_chat/agent_buttons\n * @copyright  2025 ISB Bayern\n * @author     Philipp Memmel\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport * as DomExtractor from 'block_ai_chat/dom_extractor';\n\nexport const init = () => {\n    // I hate to do this, but currently there is no other way to ensure this also works on platforms that have\n    // local_mbseasyforms installed.\n    const mbseasyformsUncollapseButton = document.querySelector('.mbseasytoggle a');\n    if (mbseasyformsUncollapseButton) {\n        mbseasyformsUncollapseButton.click();\n    }\n    // Expand all sections by \"clicking\" on the collapsed headings.\n    document.querySelectorAll('.mform fieldset.fitem.collapsible a.collapsed').forEach(collapsedHeading => {\n        collapsedHeading.click();\n    });\n\n    document.querySelectorAll('[data-block_ai_chat-action=\"accept_suggestion\"]').forEach(button => {\n        button.addEventListener('click', () => {\n            button.disabled = true;\n            const declineButton = document.querySelector(\n                '[data-block_ai_chat-action=\"decline_suggestion\"][data-block_ai_chat-for-element=\"'\n                + button.dataset.block_ai_chatForElement + '\"]'\n            );\n            declineButton.disabled = true;\n            injectSuggestionIntoForm(button);\n        });\n    });\n\n    document.querySelectorAll('[data-block_ai_chat-action=\"decline_suggestion\"]').forEach(button => {\n        button.addEventListener('click', () => {\n            button.disabled = true;\n            const acceptButton = document.querySelector(\n                '[data-block_ai_chat-action=\"accept_suggestion\"][data-block_ai_chat-for-element=\"'\n                + button.dataset.block_ai_chatForElement + '\"]'\n            );\n            acceptButton.disabled = true;\n        });\n    });\n\n    document.querySelectorAll('[data-block_ai_chat-action=\"target_suggestion\"]').forEach(button => {\n        button.addEventListener('click', () => {\n            targetFieldInView(button);\n        });\n    });\n};\n\nconst injectSuggestionIntoForm = (button) => {\n    targetFieldInView(button, 'insert');\n    const htmlElement = document.getElementById(button.dataset.block_ai_chatForElement);\n\n    const formElements = DomExtractor.extractDomElements();\n    const relatedElement = formElements.filter(formElement => formElement.id === button.dataset.block_ai_chatForElement)[0];\n\n    if (relatedElement.type === 'textarea') {\n        htmlElement.value = button.dataset.block_ai_chatSuggestionvalue;\n        const tiny = window.tinymce.get(relatedElement.id);\n        if (tiny) {\n            tiny.setContent(button.dataset.block_ai_chatSuggestionvalue);\n        }\n    } else if (relatedElement.type === 'checkbox') {\n        if (parseInt(button.dataset.block_ai_chatSuggestionvalue) === 1) {\n            // We cannot set the value, because it won't fire events. So the mform YUI won't recognize a change.\n            if (!htmlElement.checked) {\n                htmlElement.click();\n            }\n        } else {\n            if (htmlElement.checked) {\n                htmlElement.click();\n            }\n        }\n    } else if (relatedElement.type === 'select') {\n        htmlElement.value = button.dataset.block_ai_chatSuggestionvalue;\n\n        // Trigger change event to ensure any dependent JavaScript is executed\n        const changeEvent = new Event('change', {bubbles: true});\n        htmlElement.dispatchEvent(changeEvent);\n    } else {\n        // For all other input types (text, email, number, etc.)\n        htmlElement.value = button.dataset.block_ai_chatSuggestionvalue;\n    }\n};\n\nconst targetFieldInView = (button, action) => {\n    requestAnimationFrame(() => {\n        // We need to use the fitem container for example for editor fields, because tiny will hide the actual textarea.\n        let htmlElement = document.getElementById('fitem_' + button.dataset.block_ai_chatForElement);\n\n        // If there is no fitem element, we try to get the actual element.\n        if (!htmlElement) {\n            htmlElement = document.getElementById(button.dataset.block_ai_chatForElement);\n        }\n\n        if (!htmlElement) {\n            return;\n        }\n\n        // Scroll element into view with smooth behavior and center it\n        htmlElement.scrollIntoView({\n            behavior: 'smooth',\n            block: 'center',\n            inline: 'nearest'\n        });\n\n        highlightElement(htmlElement, action);\n\n        // Focus the element if it's focusable\n        requestAnimationFrame(() => {\n            htmlElement.focus();\n        });\n    });\n};\n\nconst highlightElement = (element, action) => {\n    let parent = element;\n    while (parent.tagName !== 'DIV' || !parent.classList.contains('fitem')) {\n        parent = parent.parentElement;\n    }\n\n    parent.classList.add('block_ai_chat-form_element_highlight');\n    if (action === 'insert') {\n        parent.classList.add('block_ai_chat-form_element_highlight-insert');\n    }\n    setTimeout(() => {\n        parent.classList.remove('block_ai_chat-form_element_highlight');\n        parent.classList.remove('block_ai_chat-form_element_highlight-insert');\n    }, 2000);\n};\n"],"names":["mbseasyformsUncollapseButton","document","querySelector","click","querySelectorAll","forEach","collapsedHeading","button","addEventListener","disabled","dataset","block_ai_chatForElement","injectSuggestionIntoForm","targetFieldInView","htmlElement","getElementById","relatedElement","DomExtractor","extractDomElements","filter","formElement","id","type","value","block_ai_chatSuggestionvalue","tiny","window","tinymce","get","setContent","parseInt","checked","changeEvent","Event","bubbles","dispatchEvent","action","requestAnimationFrame","scrollIntoView","behavior","block","inline","highlightElement","focus","element","parent","tagName","classList","contains","parentElement","add","setTimeout","remove"],"mappings":";;;;;;;;kCA0BoB,WAGVA,6BAA+BC,SAASC,cAAc,oBACxDF,8BACAA,6BAA6BG,QAGjCF,SAASG,iBAAiB,iDAAiDC,SAAQC,mBAC/EA,iBAAiBH,WAGrBF,SAASG,iBAAiB,mDAAmDC,SAAQE,SACjFA,OAAOC,iBAAiB,SAAS,KAC7BD,OAAOE,UAAW,EACIR,SAASC,cAC3B,oFACEK,OAAOG,QAAQC,wBAA0B,MAEjCF,UAAW,EACzBG,yBAAyBL,cAIjCN,SAASG,iBAAiB,oDAAoDC,SAAQE,SAClFA,OAAOC,iBAAiB,SAAS,KAC7BD,OAAOE,UAAW,EACGR,SAASC,cAC1B,mFACEK,OAAOG,QAAQC,wBAA0B,MAElCF,UAAW,QAIhCR,SAASG,iBAAiB,mDAAmDC,SAAQE,SACjFA,OAAOC,iBAAiB,SAAS,KAC7BK,kBAAkBN,qBAKxBK,yBAA4BL,SAC9BM,kBAAkBN,OAAQ,gBACpBO,YAAcb,SAASc,eAAeR,OAAOG,QAAQC,yBAGrDK,eADeC,aAAaC,qBACEC,QAAOC,aAAeA,YAAYC,KAAOd,OAAOG,QAAQC,0BAAyB,MAEzF,aAAxBK,eAAeM,KAAqB,CACpCR,YAAYS,MAAQhB,OAAOG,QAAQc,mCAC7BC,KAAOC,OAAOC,QAAQC,IAAIZ,eAAeK,IAC3CI,MACAA,KAAKI,WAAWtB,OAAOG,QAAQc,mCAEhC,GAA4B,aAAxBR,eAAeM,KACwC,IAA1DQ,SAASvB,OAAOG,QAAQc,8BAEnBV,YAAYiB,SACbjB,YAAYX,QAGZW,YAAYiB,SACZjB,YAAYX,aAGjB,GAA4B,WAAxBa,eAAeM,KAAmB,CACzCR,YAAYS,MAAQhB,OAAOG,QAAQc,mCAG7BQ,YAAc,IAAIC,MAAM,SAAU,CAACC,SAAS,IAClDpB,YAAYqB,cAAcH,kBAG1BlB,YAAYS,MAAQhB,OAAOG,QAAQc,8BAIrCX,kBAAoB,CAACN,OAAQ6B,UAC/BC,uBAAsB,SAEdvB,YAAcb,SAASc,eAAe,SAAWR,OAAOG,QAAQC,yBAG/DG,cACDA,YAAcb,SAASc,eAAeR,OAAOG,QAAQC,0BAGpDG,cAKLA,YAAYwB,eAAe,CACvBC,SAAU,SACVC,MAAO,SACPC,OAAQ,YAGZC,iBAAiB5B,YAAasB,QAG9BC,uBAAsB,KAClBvB,YAAY6B,gBAKlBD,iBAAmB,CAACE,QAASR,cAC3BS,OAASD,aACa,QAAnBC,OAAOC,UAAsBD,OAAOE,UAAUC,SAAS,UAC1DH,OAASA,OAAOI,cAGpBJ,OAAOE,UAAUG,IAAI,wCACN,WAAXd,QACAS,OAAOE,UAAUG,IAAI,+CAEzBC,YAAW,KACPN,OAAOE,UAAUK,OAAO,wCACxBP,OAAOE,UAAUK,OAAO,iDACzB"}